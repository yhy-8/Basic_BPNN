
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>NumPy搭建BP神经网络</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.tailwindcss.com?plugins=typography"></script>
    <script>
        tailwind.config = {
        }
    </script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.css">
    <link rel="shortcut icon" href="https://chatboxai.app/icon.png">
</head>
<body class='bg-slate-100'>
    <div class='mx-auto max-w-5xl shadow-md prose bg-white px-2 py-4'>
        <h1 class='flex flex-row justify-between items-center my-4 h-8'>
            <span>NumPy搭建BP神经网络</span>
            <a href="https://chatboxai.app" target="_blank" >
                <img src='https://chatboxai.app/icon.png' class="w-12">
            </a>
        </h1>
        <hr />
        <div class="prose-sm">
<h2>1. NumPy搭建BP神经网络</h2>
<div class="mb-4">
<p class="text-green-500 text-lg"><b>SYSTEM: </b></p>
<style data-mantine-styles="classes">@media (max-width: 35.99375em) {.mantine-visible-from-xs {display: none !important;}}@media (min-width: 36em) {.mantine-hidden-from-xs {display: none !important;}}@media (max-width: 47.99375em) {.mantine-visible-from-sm {display: none !important;}}@media (min-width: 48em) {.mantine-hidden-from-sm {display: none !important;}}@media (max-width: 61.99375em) {.mantine-visible-from-md {display: none !important;}}@media (min-width: 62em) {.mantine-hidden-from-md {display: none !important;}}@media (max-width: 74.99375em) {.mantine-visible-from-lg {display: none !important;}}@media (min-width: 75em) {.mantine-hidden-from-lg {display: none !important;}}@media (max-width: 87.99375em) {.mantine-visible-from-xl {display: none !important;}}@media (min-width: 88em) {.mantine-hidden-from-xl {display: none !important;}}</style><div class="break-words "><p>You are a helpful assistant.</p></div></div>
<div class="mb-4">
<p class="text-green-500 text-lg"><b>USER: </b></p>
<style data-mantine-styles="classes">@media (max-width: 35.99375em) {.mantine-visible-from-xs {display: none !important;}}@media (min-width: 36em) {.mantine-hidden-from-xs {display: none !important;}}@media (max-width: 47.99375em) {.mantine-visible-from-sm {display: none !important;}}@media (min-width: 48em) {.mantine-hidden-from-sm {display: none !important;}}@media (max-width: 61.99375em) {.mantine-visible-from-md {display: none !important;}}@media (min-width: 62em) {.mantine-hidden-from-md {display: none !important;}}@media (max-width: 74.99375em) {.mantine-visible-from-lg {display: none !important;}}@media (min-width: 75em) {.mantine-hidden-from-lg {display: none !important;}}@media (max-width: 87.99375em) {.mantine-visible-from-xl {display: none !important;}}@media (min-width: 88em) {.mantine-hidden-from-xl {display: none !important;}}</style><div class="break-words "><p>我现在在学习最简单的bp神经网络，也就是入门。我需要你用py写一个程序，只使用比如numpy这类基础的库来搭建一个神经网络，这样方便理解和学习。这里使用标准的官方MNIST数据集进行训练，也就是数字预测。要求输入是28*28的像素灰度值，输出数字预测，中间层有两层，每层16个神经元。同时开头先展示一下训练集的图片，以下为训练集文件描述</p>
<ol>
<li>train-images-idx3-ubyte.gz：训练集图片（9912422字节），55000张训练集，5000张验证集</li>
<li>train-labels-idx1-ubyte.gz：训练集图片对应的标签（28881字节），</li>
<li>t10k-images-idx3-ubyte .gz：测试集图片（1648877字节），10000张图片</li>
<li>t10k-labels-idx1-ubyte.gz：测试集图片对应的标签（4542字节）<br/>
图片是指0〜9手写数字图片，而标签则是对应该图片之实际数字。</li>
</ol></div></div>
<div class="mb-4">
<p class="text-blue-500 text-lg"><b>ASSISTANT: </b></p>
<style data-mantine-styles="classes">@media (max-width: 35.99375em) {.mantine-visible-from-xs {display: none !important;}}@media (min-width: 36em) {.mantine-hidden-from-xs {display: none !important;}}@media (max-width: 47.99375em) {.mantine-visible-from-sm {display: none !important;}}@media (min-width: 48em) {.mantine-hidden-from-sm {display: none !important;}}@media (max-width: 61.99375em) {.mantine-visible-from-md {display: none !important;}}@media (min-width: 62em) {.mantine-hidden-from-md {display: none !important;}}@media (max-width: 74.99375em) {.mantine-visible-from-lg {display: none !important;}}@media (min-width: 75em) {.mantine-hidden-from-lg {display: none !important;}}@media (max-width: 87.99375em) {.mantine-visible-from-xl {display: none !important;}}@media (min-width: 88em) {.mantine-hidden-from-xl {display: none !important;}}</style><div class="break-words "><p>这是一个非常好的入门项目。通过使用 <code class="bg-chatbox-background-secondary border border-solid border-chatbox-border-secondary rounded-sm px-1 py-0.5 mx-1">numpy</code> 纯手写一个神经网络，你将深入理解矩阵运算、前向传播、反向传播（梯度下降）的核心数学原理，而不是仅仅学会调用 API。</p>
<p>以下是完整的 Python 代码。代码结构清晰，分为数据加载、数据展示、网络模型定义、训练和测试几个部分。</p>
<h3>准备工作</h3>
<p>请确保你的目录下有你提到的这四个文件（不需要解压，代码会自动处理 <code class="bg-chatbox-background-secondary border border-solid border-chatbox-border-secondary rounded-sm px-1 py-0.5 mx-1">.gz</code>）：</p>
<ol>
<li><code class="bg-chatbox-background-secondary border border-solid border-chatbox-border-secondary rounded-sm px-1 py-0.5 mx-1">train-images-idx3-ubyte.gz</code></li>
<li><code class="bg-chatbox-background-secondary border border-solid border-chatbox-border-secondary rounded-sm px-1 py-0.5 mx-1">train-labels-idx1-ubyte.gz</code></li>
<li><code class="bg-chatbox-background-secondary border border-solid border-chatbox-border-secondary rounded-sm px-1 py-0.5 mx-1">t10k-images-idx3-ubyte.gz</code></li>
<li><code class="bg-chatbox-background-secondary border border-solid border-chatbox-border-secondary rounded-sm px-1 py-0.5 mx-1">t10k-labels-idx1-ubyte.gz</code></li>
</ol>
<h3>完整代码</h3>
<pre><div style="--stack-gap:0rem;--stack-align:stretch;--stack-justify:flex-start" class="m_6d731127 mantine-Stack-root"><div style="justify-content:space-between" class="p-xs bg-chatbox-background-secondary rounded-t-md border border-solid border-[var(--chatbox-border-primary)] sticky top-0 z-10 m_8bffd616 mantine-Flex-root __m__-R6ln"><div style="gap:var(--mantine-spacing-xs);align-items:center" class="m_8bffd616 mantine-Flex-root __m__-R1mmln"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--chatbox-tint-tertiary)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="tabler-icon tabler-icon-brand-python "><path d="M12 9h-7a2 2 0 0 0 -2 2v4a2 2 0 0 0 2 2h3"></path><path d="M12 15h7a2 2 0 0 0 2 -2v-4a2 2 0 0 0 -2 -2h-3"></path><path d="M8 9v-4a2 2 0 0 1 2 -2h4a2 2 0 0 1 2 2v5a2 2 0 0 1 -2 2h-4a2 2 0 0 0 -2 2v5a2 2 0 0 0 2 2h4a2 2 0 0 0 2 -2v-4"></path><path d="M11 6l0 .01"></path><path d="M13 18l0 .01"></path></svg><span style="color:chatbox-tertiary;font-weight:600" class="mantine-focus-auto font-mono m_b6d8b162 mantine-Text-root">PYTHON</span></div><div style="gap:var(--mantine-spacing-xs);align-items:center" class="m_8bffd616 mantine-Flex-root __m__-R2mmln"></div></div><div style="--stack-gap:var(--mantine-spacing-md);--stack-align:stretch;--stack-justify:flex-start" class="border border-t-0 border-solid border-[var(--chatbox-border-primary)] rounded-b-md m_6d731127 mantine-Stack-root"><div style="background:transparent !important;color:hsl(220, 14%, 71%);text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:&quot;Fira Code&quot;, &quot;Fira Mono&quot;, Menlo, Consolas, &quot;DejaVu Sans Mono&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:0;overflow:auto;border-radius:0.3em;margin-top:0;border-top-left-radius:0;border-top-right-radius:0;border-bottom-left-radius:var(--chatbox-radius-md);border-bottom-right-radius:var(--chatbox-radius-md);border:none"><code class="!bg-transparent" style="white-space:pre"><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">1</span><span class="token" style="color:hsl(286, 60%, 67%)">import</span><span> numpy </span><span class="token" style="color:hsl(286, 60%, 67%)">as</span><span> np
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">2</span><span></span><span class="token" style="color:hsl(286, 60%, 67%)">import</span><span> gzip
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">3</span><span></span><span class="token" style="color:hsl(286, 60%, 67%)">import</span><span> matplotlib</span><span class="token" style="color:hsl(220, 14%, 71%)">.</span><span>pyplot </span><span class="token" style="color:hsl(286, 60%, 67%)">as</span><span> plt
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">4</span><span></span><span class="token" style="color:hsl(286, 60%, 67%)">import</span><span> os
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">5</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">6</span><span></span><span class="token" style="color:hsl(220, 10%, 40%);font-style:italic"># ==========================================</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">7</span><span></span><span class="token" style="color:hsl(220, 10%, 40%);font-style:italic"># 1. 数据加载与预处理部分</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">8</span><span></span><span class="token" style="color:hsl(220, 10%, 40%);font-style:italic"># ==========================================</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">9</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">10</span><span></span><span class="token" style="color:hsl(286, 60%, 67%)">def</span><span> </span><span class="token" style="color:hsl(207, 82%, 66%)">load_mnist_images</span><span class="token" style="color:hsl(220, 14%, 71%)">(</span><span>filename</span><span class="token" style="color:hsl(220, 14%, 71%)">)</span><span class="token" style="color:hsl(220, 14%, 71%)">:</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">11</span><span>    </span><span class="token triple-quoted-string" style="color:hsl(95, 38%, 62%)">&quot;&quot;&quot;加载MNIST图像文件&quot;&quot;&quot;</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">12</span><span>    </span><span class="token" style="color:hsl(286, 60%, 67%)">with</span><span> gzip</span><span class="token" style="color:hsl(220, 14%, 71%)">.</span><span class="token" style="color:hsl(95, 38%, 62%)">open</span><span class="token" style="color:hsl(220, 14%, 71%)">(</span><span>filename</span><span class="token" style="color:hsl(220, 14%, 71%)">,</span><span> </span><span class="token" style="color:hsl(95, 38%, 62%)">&#x27;rb&#x27;</span><span class="token" style="color:hsl(220, 14%, 71%)">)</span><span> </span><span class="token" style="color:hsl(286, 60%, 67%)">as</span><span> f</span><span class="token" style="color:hsl(220, 14%, 71%)">:</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">13</span><span>        </span><span class="token" style="color:hsl(220, 10%, 40%);font-style:italic"># MNIST文件头描述：前16字节是魔数、图片数量、行数、列数</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">14</span><span>        </span><span class="token" style="color:hsl(220, 10%, 40%);font-style:italic"># 从第16字节开始读取数据</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">15</span><span>        data </span><span class="token" style="color:hsl(207, 82%, 66%)">=</span><span> np</span><span class="token" style="color:hsl(220, 14%, 71%)">.</span><span>frombuffer</span><span class="token" style="color:hsl(220, 14%, 71%)">(</span><span>f</span><span class="token" style="color:hsl(220, 14%, 71%)">.</span><span>read</span><span class="token" style="color:hsl(220, 14%, 71%)">(</span><span class="token" style="color:hsl(220, 14%, 71%)">)</span><span class="token" style="color:hsl(220, 14%, 71%)">,</span><span> np</span><span class="token" style="color:hsl(220, 14%, 71%)">.</span><span>uint8</span><span class="token" style="color:hsl(220, 14%, 71%)">,</span><span> offset</span><span class="token" style="color:hsl(207, 82%, 66%)">=</span><span class="token" style="color:hsl(29, 54%, 61%)">16</span><span class="token" style="color:hsl(220, 14%, 71%)">)</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">16</span><span>    </span><span class="token" style="color:hsl(220, 10%, 40%);font-style:italic"># 将数据重塑为 (图片数量, 28*28)</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">17</span><span>    </span><span class="token" style="color:hsl(220, 10%, 40%);font-style:italic"># 归一化：将像素值从 0-255 缩放到 0-1 之间，这对神经网络训练至关重要</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">18</span><span>    </span><span class="token" style="color:hsl(286, 60%, 67%)">return</span><span> data</span><span class="token" style="color:hsl(220, 14%, 71%)">.</span><span>reshape</span><span class="token" style="color:hsl(220, 14%, 71%)">(</span><span class="token" style="color:hsl(207, 82%, 66%)">-</span><span class="token" style="color:hsl(29, 54%, 61%)">1</span><span class="token" style="color:hsl(220, 14%, 71%)">,</span><span> </span><span class="token" style="color:hsl(29, 54%, 61%)">784</span><span class="token" style="color:hsl(220, 14%, 71%)">)</span><span class="token" style="color:hsl(220, 14%, 71%)">.</span><span>astype</span><span class="token" style="color:hsl(220, 14%, 71%)">(</span><span>np</span><span class="token" style="color:hsl(220, 14%, 71%)">.</span><span>float32</span><span class="token" style="color:hsl(220, 14%, 71%)">)</span><span> </span><span class="token" style="color:hsl(207, 82%, 66%)">/</span><span> </span><span class="token" style="color:hsl(29, 54%, 61%)">255.0</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">19</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">20</span><span></span><span class="token" style="color:hsl(286, 60%, 67%)">def</span><span> </span><span class="token" style="color:hsl(207, 82%, 66%)">load_mnist_labels</span><span class="token" style="color:hsl(220, 14%, 71%)">(</span><span>filename</span><span class="token" style="color:hsl(220, 14%, 71%)">)</span><span class="token" style="color:hsl(220, 14%, 71%)">:</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">21</span><span>    </span><span class="token triple-quoted-string" style="color:hsl(95, 38%, 62%)">&quot;&quot;&quot;加载MNIST标签文件&quot;&quot;&quot;</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">22</span><span>    </span><span class="token" style="color:hsl(286, 60%, 67%)">with</span><span> gzip</span><span class="token" style="color:hsl(220, 14%, 71%)">.</span><span class="token" style="color:hsl(95, 38%, 62%)">open</span><span class="token" style="color:hsl(220, 14%, 71%)">(</span><span>filename</span><span class="token" style="color:hsl(220, 14%, 71%)">,</span><span> </span><span class="token" style="color:hsl(95, 38%, 62%)">&#x27;rb&#x27;</span><span class="token" style="color:hsl(220, 14%, 71%)">)</span><span> </span><span class="token" style="color:hsl(286, 60%, 67%)">as</span><span> f</span><span class="token" style="color:hsl(220, 14%, 71%)">:</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">23</span><span>        </span><span class="token" style="color:hsl(220, 10%, 40%);font-style:italic"># 前8字节是魔数和标签数量</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">24</span><span>        </span><span class="token" style="color:hsl(220, 10%, 40%);font-style:italic"># 从第8字节开始读取数据</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">25</span><span>        data </span><span class="token" style="color:hsl(207, 82%, 66%)">=</span><span> np</span><span class="token" style="color:hsl(220, 14%, 71%)">.</span><span>frombuffer</span><span class="token" style="color:hsl(220, 14%, 71%)">(</span><span>f</span><span class="token" style="color:hsl(220, 14%, 71%)">.</span><span>read</span><span class="token" style="color:hsl(220, 14%, 71%)">(</span><span class="token" style="color:hsl(220, 14%, 71%)">)</span><span class="token" style="color:hsl(220, 14%, 71%)">,</span><span> np</span><span class="token" style="color:hsl(220, 14%, 71%)">.</span><span>uint8</span><span class="token" style="color:hsl(220, 14%, 71%)">,</span><span> offset</span><span class="token" style="color:hsl(207, 82%, 66%)">=</span><span class="token" style="color:hsl(29, 54%, 61%)">8</span><span class="token" style="color:hsl(220, 14%, 71%)">)</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">26</span><span>    </span><span class="token" style="color:hsl(286, 60%, 67%)">return</span><span> data
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">27</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">28</span><span></span><span class="token" style="color:hsl(286, 60%, 67%)">def</span><span> </span><span class="token" style="color:hsl(207, 82%, 66%)">one_hot_encode</span><span class="token" style="color:hsl(220, 14%, 71%)">(</span><span>y</span><span class="token" style="color:hsl(220, 14%, 71%)">,</span><span> num_classes</span><span class="token" style="color:hsl(207, 82%, 66%)">=</span><span class="token" style="color:hsl(29, 54%, 61%)">10</span><span class="token" style="color:hsl(220, 14%, 71%)">)</span><span class="token" style="color:hsl(220, 14%, 71%)">:</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">29</span><span>    </span><span class="token triple-quoted-string" style="color:hsl(95, 38%, 62%)">&quot;&quot;&quot;将标签转换为独热编码 (One-Hot Encoding)&quot;&quot;&quot;</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">30</span><span>    </span><span class="token" style="color:hsl(220, 10%, 40%);font-style:italic"># 例如：标签 3 变成 [0, 0, 0, 1, 0, 0, 0, 0, 0, 0]</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">31</span><span>    </span><span class="token" style="color:hsl(286, 60%, 67%)">return</span><span> np</span><span class="token" style="color:hsl(220, 14%, 71%)">.</span><span>eye</span><span class="token" style="color:hsl(220, 14%, 71%)">(</span><span>num_classes</span><span class="token" style="color:hsl(220, 14%, 71%)">)</span><span class="token" style="color:hsl(220, 14%, 71%)">[</span><span>y</span><span class="token" style="color:hsl(220, 14%, 71%)">]</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">32</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">33</span><span></span><span class="token" style="color:hsl(220, 10%, 40%);font-style:italic"># 设置文件路径（请确保文件在当前目录下，或者修改为你的绝对路径）</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">34</span><span>files </span><span class="token" style="color:hsl(207, 82%, 66%)">=</span><span> </span><span class="token" style="color:hsl(220, 14%, 71%)">{</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">35</span><span>    </span><span class="token" style="color:hsl(95, 38%, 62%)">&#x27;train_img&#x27;</span><span class="token" style="color:hsl(220, 14%, 71%)">:</span><span> </span><span class="token" style="color:hsl(95, 38%, 62%)">&#x27;train-images-idx3-ubyte.gz&#x27;</span><span class="token" style="color:hsl(220, 14%, 71%)">,</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">36</span><span>    </span><span class="token" style="color:hsl(95, 38%, 62%)">&#x27;train_lbl&#x27;</span><span class="token" style="color:hsl(220, 14%, 71%)">:</span><span> </span><span class="token" style="color:hsl(95, 38%, 62%)">&#x27;train-labels-idx1-ubyte.gz&#x27;</span><span class="token" style="color:hsl(220, 14%, 71%)">,</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">37</span><span>    </span><span class="token" style="color:hsl(95, 38%, 62%)">&#x27;test_img&#x27;</span><span class="token" style="color:hsl(220, 14%, 71%)">:</span><span> </span><span class="token" style="color:hsl(95, 38%, 62%)">&#x27;t10k-images-idx3-ubyte.gz&#x27;</span><span class="token" style="color:hsl(220, 14%, 71%)">,</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">38</span><span>    </span><span class="token" style="color:hsl(95, 38%, 62%)">&#x27;test_lbl&#x27;</span><span class="token" style="color:hsl(220, 14%, 71%)">:</span><span> </span><span class="token" style="color:hsl(95, 38%, 62%)">&#x27;t10k-labels-idx1-ubyte.gz&#x27;</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">39</span><span></span><span class="token" style="color:hsl(220, 14%, 71%)">}</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">40</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">41</span><span></span><span class="token" style="color:hsl(286, 60%, 67%)">print</span><span class="token" style="color:hsl(220, 14%, 71%)">(</span><span class="token" style="color:hsl(95, 38%, 62%)">&quot;正在加载数据...&quot;</span><span class="token" style="color:hsl(220, 14%, 71%)">)</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">42</span><span></span><span class="token" style="color:hsl(220, 10%, 40%);font-style:italic"># 检查文件是否存在</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">43</span><span></span><span class="token" style="color:hsl(286, 60%, 67%)">for</span><span> k</span><span class="token" style="color:hsl(220, 14%, 71%)">,</span><span> v </span><span class="token" style="color:hsl(286, 60%, 67%)">in</span><span> files</span><span class="token" style="color:hsl(220, 14%, 71%)">.</span><span>items</span><span class="token" style="color:hsl(220, 14%, 71%)">(</span><span class="token" style="color:hsl(220, 14%, 71%)">)</span><span class="token" style="color:hsl(220, 14%, 71%)">:</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">44</span><span>    </span><span class="token" style="color:hsl(286, 60%, 67%)">if</span><span> </span><span class="token" style="color:hsl(286, 60%, 67%)">not</span><span> os</span><span class="token" style="color:hsl(220, 14%, 71%)">.</span><span>path</span><span class="token" style="color:hsl(220, 14%, 71%)">.</span><span>exists</span><span class="token" style="color:hsl(220, 14%, 71%)">(</span><span>v</span><span class="token" style="color:hsl(220, 14%, 71%)">)</span><span class="token" style="color:hsl(220, 14%, 71%)">:</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">45</span><span>        </span><span class="token" style="color:hsl(286, 60%, 67%)">print</span><span class="token" style="color:hsl(220, 14%, 71%)">(</span><span class="token string-interpolation" style="color:hsl(95, 38%, 62%)">f&quot;错误：找不到文件 </span><span class="token string-interpolation interpolation" style="color:hsl(220, 14%, 71%)">{</span><span class="token string-interpolation interpolation">v</span><span class="token string-interpolation interpolation" style="color:hsl(220, 14%, 71%)">}</span><span class="token string-interpolation" style="color:hsl(95, 38%, 62%)">，请确保文件在当前目录下。&quot;</span><span class="token" style="color:hsl(220, 14%, 71%)">)</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">46</span><span>        exit</span><span class="token" style="color:hsl(220, 14%, 71%)">(</span><span class="token" style="color:hsl(220, 14%, 71%)">)</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">47</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">48</span><span>X_train </span><span class="token" style="color:hsl(207, 82%, 66%)">=</span><span> load_mnist_images</span><span class="token" style="color:hsl(220, 14%, 71%)">(</span><span>files</span><span class="token" style="color:hsl(220, 14%, 71%)">[</span><span class="token" style="color:hsl(95, 38%, 62%)">&#x27;train_img&#x27;</span><span class="token" style="color:hsl(220, 14%, 71%)">]</span><span class="token" style="color:hsl(220, 14%, 71%)">)</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">49</span><span>y_train_raw </span><span class="token" style="color:hsl(207, 82%, 66%)">=</span><span> load_mnist_labels</span><span class="token" style="color:hsl(220, 14%, 71%)">(</span><span>files</span><span class="token" style="color:hsl(220, 14%, 71%)">[</span><span class="token" style="color:hsl(95, 38%, 62%)">&#x27;train_lbl&#x27;</span><span class="token" style="color:hsl(220, 14%, 71%)">]</span><span class="token" style="color:hsl(220, 14%, 71%)">)</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">50</span><span>X_test </span><span class="token" style="color:hsl(207, 82%, 66%)">=</span><span> load_mnist_images</span><span class="token" style="color:hsl(220, 14%, 71%)">(</span><span>files</span><span class="token" style="color:hsl(220, 14%, 71%)">[</span><span class="token" style="color:hsl(95, 38%, 62%)">&#x27;test_img&#x27;</span><span class="token" style="color:hsl(220, 14%, 71%)">]</span><span class="token" style="color:hsl(220, 14%, 71%)">)</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">51</span><span>y_test_raw </span><span class="token" style="color:hsl(207, 82%, 66%)">=</span><span> load_mnist_labels</span><span class="token" style="color:hsl(220, 14%, 71%)">(</span><span>files</span><span class="token" style="color:hsl(220, 14%, 71%)">[</span><span class="token" style="color:hsl(95, 38%, 62%)">&#x27;test_lbl&#x27;</span><span class="token" style="color:hsl(220, 14%, 71%)">]</span><span class="token" style="color:hsl(220, 14%, 71%)">)</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">52</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">53</span><span></span><span class="token" style="color:hsl(220, 10%, 40%);font-style:italic"># 转换标签为 One-Hot 格式</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">54</span><span>y_train </span><span class="token" style="color:hsl(207, 82%, 66%)">=</span><span> one_hot_encode</span><span class="token" style="color:hsl(220, 14%, 71%)">(</span><span>y_train_raw</span><span class="token" style="color:hsl(220, 14%, 71%)">)</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">55</span><span>y_test </span><span class="token" style="color:hsl(207, 82%, 66%)">=</span><span> one_hot_encode</span><span class="token" style="color:hsl(220, 14%, 71%)">(</span><span>y_test_raw</span><span class="token" style="color:hsl(220, 14%, 71%)">)</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">56</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">57</span><span></span><span class="token" style="color:hsl(286, 60%, 67%)">print</span><span class="token" style="color:hsl(220, 14%, 71%)">(</span><span class="token string-interpolation" style="color:hsl(95, 38%, 62%)">f&quot;训练集形状: </span><span class="token string-interpolation interpolation" style="color:hsl(220, 14%, 71%)">{</span><span class="token string-interpolation interpolation">X_train</span><span class="token string-interpolation interpolation" style="color:hsl(220, 14%, 71%)">.</span><span class="token string-interpolation interpolation">shape</span><span class="token string-interpolation interpolation" style="color:hsl(220, 14%, 71%)">}</span><span class="token string-interpolation" style="color:hsl(95, 38%, 62%)">, 标签形状: </span><span class="token string-interpolation interpolation" style="color:hsl(220, 14%, 71%)">{</span><span class="token string-interpolation interpolation">y_train</span><span class="token string-interpolation interpolation" style="color:hsl(220, 14%, 71%)">.</span><span class="token string-interpolation interpolation">shape</span><span class="token string-interpolation interpolation" style="color:hsl(220, 14%, 71%)">}</span><span class="token string-interpolation" style="color:hsl(95, 38%, 62%)">&quot;</span><span class="token" style="color:hsl(220, 14%, 71%)">)</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">58</span><span></span><span class="token" style="color:hsl(286, 60%, 67%)">print</span><span class="token" style="color:hsl(220, 14%, 71%)">(</span><span class="token string-interpolation" style="color:hsl(95, 38%, 62%)">f&quot;测试集形状: </span><span class="token string-interpolation interpolation" style="color:hsl(220, 14%, 71%)">{</span><span class="token string-interpolation interpolation">X_test</span><span class="token string-interpolation interpolation" style="color:hsl(220, 14%, 71%)">.</span><span class="token string-interpolation interpolation">shape</span><span class="token string-interpolation interpolation" style="color:hsl(220, 14%, 71%)">}</span><span class="token string-interpolation" style="color:hsl(95, 38%, 62%)">, 标签形状: </span><span class="token string-interpolation interpolation" style="color:hsl(220, 14%, 71%)">{</span><span class="token string-interpolation interpolation">y_test</span><span class="token string-interpolation interpolation" style="color:hsl(220, 14%, 71%)">.</span><span class="token string-interpolation interpolation">shape</span><span class="token string-interpolation interpolation" style="color:hsl(220, 14%, 71%)">}</span><span class="token string-interpolation" style="color:hsl(95, 38%, 62%)">&quot;</span><span class="token" style="color:hsl(220, 14%, 71%)">)</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">59</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">60</span><span></span><span class="token" style="color:hsl(220, 10%, 40%);font-style:italic"># ==========================================</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">61</span><span></span><span class="token" style="color:hsl(220, 10%, 40%);font-style:italic"># 2. 开头展示训练集图片</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">62</span><span></span><span class="token" style="color:hsl(220, 10%, 40%);font-style:italic"># ==========================================</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">63</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">64</span><span></span><span class="token" style="color:hsl(286, 60%, 67%)">def</span><span> </span><span class="token" style="color:hsl(207, 82%, 66%)">show_examples</span><span class="token" style="color:hsl(220, 14%, 71%)">(</span><span>images</span><span class="token" style="color:hsl(220, 14%, 71%)">,</span><span> labels</span><span class="token" style="color:hsl(220, 14%, 71%)">)</span><span class="token" style="color:hsl(220, 14%, 71%)">:</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">65</span><span>    plt</span><span class="token" style="color:hsl(220, 14%, 71%)">.</span><span>figure</span><span class="token" style="color:hsl(220, 14%, 71%)">(</span><span>figsize</span><span class="token" style="color:hsl(207, 82%, 66%)">=</span><span class="token" style="color:hsl(220, 14%, 71%)">(</span><span class="token" style="color:hsl(29, 54%, 61%)">10</span><span class="token" style="color:hsl(220, 14%, 71%)">,</span><span> </span><span class="token" style="color:hsl(29, 54%, 61%)">5</span><span class="token" style="color:hsl(220, 14%, 71%)">)</span><span class="token" style="color:hsl(220, 14%, 71%)">)</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">66</span><span>    </span><span class="token" style="color:hsl(286, 60%, 67%)">for</span><span> i </span><span class="token" style="color:hsl(286, 60%, 67%)">in</span><span> </span><span class="token" style="color:hsl(95, 38%, 62%)">range</span><span class="token" style="color:hsl(220, 14%, 71%)">(</span><span class="token" style="color:hsl(29, 54%, 61%)">10</span><span class="token" style="color:hsl(220, 14%, 71%)">)</span><span class="token" style="color:hsl(220, 14%, 71%)">:</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">67</span><span>        plt</span><span class="token" style="color:hsl(220, 14%, 71%)">.</span><span>subplot</span><span class="token" style="color:hsl(220, 14%, 71%)">(</span><span class="token" style="color:hsl(29, 54%, 61%)">2</span><span class="token" style="color:hsl(220, 14%, 71%)">,</span><span> </span><span class="token" style="color:hsl(29, 54%, 61%)">5</span><span class="token" style="color:hsl(220, 14%, 71%)">,</span><span> i </span><span class="token" style="color:hsl(207, 82%, 66%)">+</span><span> </span><span class="token" style="color:hsl(29, 54%, 61%)">1</span><span class="token" style="color:hsl(220, 14%, 71%)">)</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">68</span><span>        </span><span class="token" style="color:hsl(220, 10%, 40%);font-style:italic"># 将 784 维向量还原回 28x28 用于显示</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">69</span><span>        img </span><span class="token" style="color:hsl(207, 82%, 66%)">=</span><span> images</span><span class="token" style="color:hsl(220, 14%, 71%)">[</span><span>i</span><span class="token" style="color:hsl(220, 14%, 71%)">]</span><span class="token" style="color:hsl(220, 14%, 71%)">.</span><span>reshape</span><span class="token" style="color:hsl(220, 14%, 71%)">(</span><span class="token" style="color:hsl(29, 54%, 61%)">28</span><span class="token" style="color:hsl(220, 14%, 71%)">,</span><span> </span><span class="token" style="color:hsl(29, 54%, 61%)">28</span><span class="token" style="color:hsl(220, 14%, 71%)">)</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">70</span><span>        plt</span><span class="token" style="color:hsl(220, 14%, 71%)">.</span><span>imshow</span><span class="token" style="color:hsl(220, 14%, 71%)">(</span><span>img</span><span class="token" style="color:hsl(220, 14%, 71%)">,</span><span> cmap</span><span class="token" style="color:hsl(207, 82%, 66%)">=</span><span class="token" style="color:hsl(95, 38%, 62%)">&#x27;gray&#x27;</span><span class="token" style="color:hsl(220, 14%, 71%)">)</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">71</span><span>        plt</span><span class="token" style="color:hsl(220, 14%, 71%)">.</span><span>title</span><span class="token" style="color:hsl(220, 14%, 71%)">(</span><span class="token string-interpolation" style="color:hsl(95, 38%, 62%)">f&quot;Label: </span><span class="token string-interpolation interpolation" style="color:hsl(220, 14%, 71%)">{</span><span class="token string-interpolation interpolation">labels</span><span class="token string-interpolation interpolation" style="color:hsl(220, 14%, 71%)">[</span><span class="token string-interpolation interpolation">i</span><span class="token string-interpolation interpolation" style="color:hsl(220, 14%, 71%)">]</span><span class="token string-interpolation interpolation" style="color:hsl(220, 14%, 71%)">}</span><span class="token string-interpolation" style="color:hsl(95, 38%, 62%)">&quot;</span><span class="token" style="color:hsl(220, 14%, 71%)">)</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">72</span><span>        plt</span><span class="token" style="color:hsl(220, 14%, 71%)">.</span><span>axis</span><span class="token" style="color:hsl(220, 14%, 71%)">(</span><span class="token" style="color:hsl(95, 38%, 62%)">&#x27;off&#x27;</span><span class="token" style="color:hsl(220, 14%, 71%)">)</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">73</span><span>    plt</span><span class="token" style="color:hsl(220, 14%, 71%)">.</span><span>tight_layout</span><span class="token" style="color:hsl(220, 14%, 71%)">(</span><span class="token" style="color:hsl(220, 14%, 71%)">)</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">74</span><span>    plt</span><span class="token" style="color:hsl(220, 14%, 71%)">.</span><span>show</span><span class="token" style="color:hsl(220, 14%, 71%)">(</span><span class="token" style="color:hsl(220, 14%, 71%)">)</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">75</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">76</span><span></span><span class="token" style="color:hsl(286, 60%, 67%)">print</span><span class="token" style="color:hsl(220, 14%, 71%)">(</span><span class="token" style="color:hsl(95, 38%, 62%)">&quot;展示前10张训练图片...&quot;</span><span class="token" style="color:hsl(220, 14%, 71%)">)</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">77</span><span>show_examples</span><span class="token" style="color:hsl(220, 14%, 71%)">(</span><span>X_train</span><span class="token" style="color:hsl(220, 14%, 71%)">,</span><span> y_train_raw</span><span class="token" style="color:hsl(220, 14%, 71%)">)</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">78</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">79</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">80</span><span></span><span class="token" style="color:hsl(220, 10%, 40%);font-style:italic"># ==========================================</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">81</span><span></span><span class="token" style="color:hsl(220, 10%, 40%);font-style:italic"># 3. 神经网络类定义 (BP核心)</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">82</span><span></span><span class="token" style="color:hsl(220, 10%, 40%);font-style:italic"># ==========================================</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">83</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">84</span><span></span><span class="token" style="color:hsl(286, 60%, 67%)">class</span><span> </span><span class="token" style="color:hsl(29, 54%, 61%)">NeuralNetwork</span><span class="token" style="color:hsl(220, 14%, 71%)">:</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">85</span><span>    </span><span class="token" style="color:hsl(286, 60%, 67%)">def</span><span> </span><span class="token" style="color:hsl(207, 82%, 66%)">__init__</span><span class="token" style="color:hsl(220, 14%, 71%)">(</span><span>self</span><span class="token" style="color:hsl(220, 14%, 71%)">,</span><span> input_size</span><span class="token" style="color:hsl(220, 14%, 71%)">,</span><span> hidden_size</span><span class="token" style="color:hsl(220, 14%, 71%)">,</span><span> output_size</span><span class="token" style="color:hsl(220, 14%, 71%)">,</span><span> learning_rate</span><span class="token" style="color:hsl(207, 82%, 66%)">=</span><span class="token" style="color:hsl(29, 54%, 61%)">0.1</span><span class="token" style="color:hsl(220, 14%, 71%)">)</span><span class="token" style="color:hsl(220, 14%, 71%)">:</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">86</span><span>        self</span><span class="token" style="color:hsl(220, 14%, 71%)">.</span><span>lr </span><span class="token" style="color:hsl(207, 82%, 66%)">=</span><span> learning_rate
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">87</span>        
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">88</span><span>        </span><span class="token" style="color:hsl(220, 10%, 40%);font-style:italic"># 初始化权重和偏置</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">89</span><span>        </span><span class="token" style="color:hsl(220, 10%, 40%);font-style:italic"># 使用正态分布随机初始化，乘以0.01是为了让数值较小，利于收敛</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">90</span><span>        </span><span class="token" style="color:hsl(220, 10%, 40%);font-style:italic"># W1: 输入层 -&gt; 隐藏层1 (784 -&gt; 16)</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">91</span><span>        self</span><span class="token" style="color:hsl(220, 14%, 71%)">.</span><span>W1 </span><span class="token" style="color:hsl(207, 82%, 66%)">=</span><span> np</span><span class="token" style="color:hsl(220, 14%, 71%)">.</span><span>random</span><span class="token" style="color:hsl(220, 14%, 71%)">.</span><span>randn</span><span class="token" style="color:hsl(220, 14%, 71%)">(</span><span>input_size</span><span class="token" style="color:hsl(220, 14%, 71%)">,</span><span> hidden_size</span><span class="token" style="color:hsl(220, 14%, 71%)">)</span><span> </span><span class="token" style="color:hsl(207, 82%, 66%)">*</span><span> </span><span class="token" style="color:hsl(29, 54%, 61%)">0.01</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">92</span><span>        self</span><span class="token" style="color:hsl(220, 14%, 71%)">.</span><span>b1 </span><span class="token" style="color:hsl(207, 82%, 66%)">=</span><span> np</span><span class="token" style="color:hsl(220, 14%, 71%)">.</span><span>zeros</span><span class="token" style="color:hsl(220, 14%, 71%)">(</span><span class="token" style="color:hsl(220, 14%, 71%)">(</span><span class="token" style="color:hsl(29, 54%, 61%)">1</span><span class="token" style="color:hsl(220, 14%, 71%)">,</span><span> hidden_size</span><span class="token" style="color:hsl(220, 14%, 71%)">)</span><span class="token" style="color:hsl(220, 14%, 71%)">)</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">93</span>        
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">94</span><span>        </span><span class="token" style="color:hsl(220, 10%, 40%);font-style:italic"># W2: 隐藏层1 -&gt; 隐藏层2 (16 -&gt; 16)</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">95</span><span>        self</span><span class="token" style="color:hsl(220, 14%, 71%)">.</span><span>W2 </span><span class="token" style="color:hsl(207, 82%, 66%)">=</span><span> np</span><span class="token" style="color:hsl(220, 14%, 71%)">.</span><span>random</span><span class="token" style="color:hsl(220, 14%, 71%)">.</span><span>randn</span><span class="token" style="color:hsl(220, 14%, 71%)">(</span><span>hidden_size</span><span class="token" style="color:hsl(220, 14%, 71%)">,</span><span> hidden_size</span><span class="token" style="color:hsl(220, 14%, 71%)">)</span><span> </span><span class="token" style="color:hsl(207, 82%, 66%)">*</span><span> </span><span class="token" style="color:hsl(29, 54%, 61%)">0.01</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">96</span><span>        self</span><span class="token" style="color:hsl(220, 14%, 71%)">.</span><span>b2 </span><span class="token" style="color:hsl(207, 82%, 66%)">=</span><span> np</span><span class="token" style="color:hsl(220, 14%, 71%)">.</span><span>zeros</span><span class="token" style="color:hsl(220, 14%, 71%)">(</span><span class="token" style="color:hsl(220, 14%, 71%)">(</span><span class="token" style="color:hsl(29, 54%, 61%)">1</span><span class="token" style="color:hsl(220, 14%, 71%)">,</span><span> hidden_size</span><span class="token" style="color:hsl(220, 14%, 71%)">)</span><span class="token" style="color:hsl(220, 14%, 71%)">)</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">97</span>        
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">98</span><span>        </span><span class="token" style="color:hsl(220, 10%, 40%);font-style:italic"># W3: 隐藏层2 -&gt; 输出层 (16 -&gt; 10)</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">99</span><span>        self</span><span class="token" style="color:hsl(220, 14%, 71%)">.</span><span>W3 </span><span class="token" style="color:hsl(207, 82%, 66%)">=</span><span> np</span><span class="token" style="color:hsl(220, 14%, 71%)">.</span><span>random</span><span class="token" style="color:hsl(220, 14%, 71%)">.</span><span>randn</span><span class="token" style="color:hsl(220, 14%, 71%)">(</span><span>hidden_size</span><span class="token" style="color:hsl(220, 14%, 71%)">,</span><span> output_size</span><span class="token" style="color:hsl(220, 14%, 71%)">)</span><span> </span><span class="token" style="color:hsl(207, 82%, 66%)">*</span><span> </span><span class="token" style="color:hsl(29, 54%, 61%)">0.01</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">100</span><span>        self</span><span class="token" style="color:hsl(220, 14%, 71%)">.</span><span>b3 </span><span class="token" style="color:hsl(207, 82%, 66%)">=</span><span> np</span><span class="token" style="color:hsl(220, 14%, 71%)">.</span><span>zeros</span><span class="token" style="color:hsl(220, 14%, 71%)">(</span><span class="token" style="color:hsl(220, 14%, 71%)">(</span><span class="token" style="color:hsl(29, 54%, 61%)">1</span><span class="token" style="color:hsl(220, 14%, 71%)">,</span><span> output_size</span><span class="token" style="color:hsl(220, 14%, 71%)">)</span><span class="token" style="color:hsl(220, 14%, 71%)">)</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">101</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">102</span><span>    </span><span class="token" style="color:hsl(286, 60%, 67%)">def</span><span> </span><span class="token" style="color:hsl(207, 82%, 66%)">sigmoid</span><span class="token" style="color:hsl(220, 14%, 71%)">(</span><span>self</span><span class="token" style="color:hsl(220, 14%, 71%)">,</span><span> z</span><span class="token" style="color:hsl(220, 14%, 71%)">)</span><span class="token" style="color:hsl(220, 14%, 71%)">:</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">103</span><span>        </span><span class="token triple-quoted-string" style="color:hsl(95, 38%, 62%)">&quot;&quot;&quot;Sigmoid 激活函数&quot;&quot;&quot;</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">104</span><span>        </span><span class="token" style="color:hsl(286, 60%, 67%)">return</span><span> </span><span class="token" style="color:hsl(29, 54%, 61%)">1</span><span> </span><span class="token" style="color:hsl(207, 82%, 66%)">/</span><span> </span><span class="token" style="color:hsl(220, 14%, 71%)">(</span><span class="token" style="color:hsl(29, 54%, 61%)">1</span><span> </span><span class="token" style="color:hsl(207, 82%, 66%)">+</span><span> np</span><span class="token" style="color:hsl(220, 14%, 71%)">.</span><span>exp</span><span class="token" style="color:hsl(220, 14%, 71%)">(</span><span class="token" style="color:hsl(207, 82%, 66%)">-</span><span>z</span><span class="token" style="color:hsl(220, 14%, 71%)">)</span><span class="token" style="color:hsl(220, 14%, 71%)">)</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">105</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">106</span><span>    </span><span class="token" style="color:hsl(286, 60%, 67%)">def</span><span> </span><span class="token" style="color:hsl(207, 82%, 66%)">sigmoid_derivative</span><span class="token" style="color:hsl(220, 14%, 71%)">(</span><span>self</span><span class="token" style="color:hsl(220, 14%, 71%)">,</span><span> a</span><span class="token" style="color:hsl(220, 14%, 71%)">)</span><span class="token" style="color:hsl(220, 14%, 71%)">:</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">107</span><span>        </span><span class="token triple-quoted-string" style="color:hsl(95, 38%, 62%)">&quot;&quot;&quot;Sigmoid 的导数，输入 a 是已经经过 sigmoid 激活的值&quot;&quot;&quot;</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">108</span><span>        </span><span class="token" style="color:hsl(286, 60%, 67%)">return</span><span> a </span><span class="token" style="color:hsl(207, 82%, 66%)">*</span><span> </span><span class="token" style="color:hsl(220, 14%, 71%)">(</span><span class="token" style="color:hsl(29, 54%, 61%)">1</span><span> </span><span class="token" style="color:hsl(207, 82%, 66%)">-</span><span> a</span><span class="token" style="color:hsl(220, 14%, 71%)">)</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">109</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">110</span><span>    </span><span class="token" style="color:hsl(286, 60%, 67%)">def</span><span> </span><span class="token" style="color:hsl(207, 82%, 66%)">softmax</span><span class="token" style="color:hsl(220, 14%, 71%)">(</span><span>self</span><span class="token" style="color:hsl(220, 14%, 71%)">,</span><span> z</span><span class="token" style="color:hsl(220, 14%, 71%)">)</span><span class="token" style="color:hsl(220, 14%, 71%)">:</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">111</span><span>        </span><span class="token triple-quoted-string" style="color:hsl(95, 38%, 62%)">&quot;&quot;&quot;Softmax 激活函数 (用于多分类输出)&quot;&quot;&quot;</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">112</span><span>        </span><span class="token" style="color:hsl(220, 10%, 40%);font-style:italic"># 减去最大值是为了防止 exp 计算溢出</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">113</span><span>        exp_z </span><span class="token" style="color:hsl(207, 82%, 66%)">=</span><span> np</span><span class="token" style="color:hsl(220, 14%, 71%)">.</span><span>exp</span><span class="token" style="color:hsl(220, 14%, 71%)">(</span><span>z </span><span class="token" style="color:hsl(207, 82%, 66%)">-</span><span> np</span><span class="token" style="color:hsl(220, 14%, 71%)">.</span><span class="token" style="color:hsl(95, 38%, 62%)">max</span><span class="token" style="color:hsl(220, 14%, 71%)">(</span><span>z</span><span class="token" style="color:hsl(220, 14%, 71%)">,</span><span> axis</span><span class="token" style="color:hsl(207, 82%, 66%)">=</span><span class="token" style="color:hsl(29, 54%, 61%)">1</span><span class="token" style="color:hsl(220, 14%, 71%)">,</span><span> keepdims</span><span class="token" style="color:hsl(207, 82%, 66%)">=</span><span class="token" style="color:hsl(29, 54%, 61%)">True</span><span class="token" style="color:hsl(220, 14%, 71%)">)</span><span class="token" style="color:hsl(220, 14%, 71%)">)</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">114</span><span>        </span><span class="token" style="color:hsl(286, 60%, 67%)">return</span><span> exp_z </span><span class="token" style="color:hsl(207, 82%, 66%)">/</span><span> np</span><span class="token" style="color:hsl(220, 14%, 71%)">.</span><span class="token" style="color:hsl(95, 38%, 62%)">sum</span><span class="token" style="color:hsl(220, 14%, 71%)">(</span><span>exp_z</span><span class="token" style="color:hsl(220, 14%, 71%)">,</span><span> axis</span><span class="token" style="color:hsl(207, 82%, 66%)">=</span><span class="token" style="color:hsl(29, 54%, 61%)">1</span><span class="token" style="color:hsl(220, 14%, 71%)">,</span><span> keepdims</span><span class="token" style="color:hsl(207, 82%, 66%)">=</span><span class="token" style="color:hsl(29, 54%, 61%)">True</span><span class="token" style="color:hsl(220, 14%, 71%)">)</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">115</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">116</span><span>    </span><span class="token" style="color:hsl(286, 60%, 67%)">def</span><span> </span><span class="token" style="color:hsl(207, 82%, 66%)">forward</span><span class="token" style="color:hsl(220, 14%, 71%)">(</span><span>self</span><span class="token" style="color:hsl(220, 14%, 71%)">,</span><span> X</span><span class="token" style="color:hsl(220, 14%, 71%)">)</span><span class="token" style="color:hsl(220, 14%, 71%)">:</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">117</span><span>        </span><span class="token triple-quoted-string" style="color:hsl(95, 38%, 62%)">&quot;&quot;&quot;前向传播&quot;&quot;&quot;</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">118</span><span>        </span><span class="token" style="color:hsl(220, 10%, 40%);font-style:italic"># 第一层 (Input -&gt; Hidden 1)</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">119</span><span>        self</span><span class="token" style="color:hsl(220, 14%, 71%)">.</span><span>Z1 </span><span class="token" style="color:hsl(207, 82%, 66%)">=</span><span> np</span><span class="token" style="color:hsl(220, 14%, 71%)">.</span><span>dot</span><span class="token" style="color:hsl(220, 14%, 71%)">(</span><span>X</span><span class="token" style="color:hsl(220, 14%, 71%)">,</span><span> self</span><span class="token" style="color:hsl(220, 14%, 71%)">.</span><span>W1</span><span class="token" style="color:hsl(220, 14%, 71%)">)</span><span> </span><span class="token" style="color:hsl(207, 82%, 66%)">+</span><span> self</span><span class="token" style="color:hsl(220, 14%, 71%)">.</span><span>b1
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">120</span><span>        self</span><span class="token" style="color:hsl(220, 14%, 71%)">.</span><span>A1 </span><span class="token" style="color:hsl(207, 82%, 66%)">=</span><span> self</span><span class="token" style="color:hsl(220, 14%, 71%)">.</span><span>sigmoid</span><span class="token" style="color:hsl(220, 14%, 71%)">(</span><span>self</span><span class="token" style="color:hsl(220, 14%, 71%)">.</span><span>Z1</span><span class="token" style="color:hsl(220, 14%, 71%)">)</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">121</span>        
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">122</span><span>        </span><span class="token" style="color:hsl(220, 10%, 40%);font-style:italic"># 第二层 (Hidden 1 -&gt; Hidden 2)</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">123</span><span>        self</span><span class="token" style="color:hsl(220, 14%, 71%)">.</span><span>Z2 </span><span class="token" style="color:hsl(207, 82%, 66%)">=</span><span> np</span><span class="token" style="color:hsl(220, 14%, 71%)">.</span><span>dot</span><span class="token" style="color:hsl(220, 14%, 71%)">(</span><span>self</span><span class="token" style="color:hsl(220, 14%, 71%)">.</span><span>A1</span><span class="token" style="color:hsl(220, 14%, 71%)">,</span><span> self</span><span class="token" style="color:hsl(220, 14%, 71%)">.</span><span>W2</span><span class="token" style="color:hsl(220, 14%, 71%)">)</span><span> </span><span class="token" style="color:hsl(207, 82%, 66%)">+</span><span> self</span><span class="token" style="color:hsl(220, 14%, 71%)">.</span><span>b2
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">124</span><span>        self</span><span class="token" style="color:hsl(220, 14%, 71%)">.</span><span>A2 </span><span class="token" style="color:hsl(207, 82%, 66%)">=</span><span> self</span><span class="token" style="color:hsl(220, 14%, 71%)">.</span><span>sigmoid</span><span class="token" style="color:hsl(220, 14%, 71%)">(</span><span>self</span><span class="token" style="color:hsl(220, 14%, 71%)">.</span><span>Z2</span><span class="token" style="color:hsl(220, 14%, 71%)">)</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">125</span>        
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">126</span><span>        </span><span class="token" style="color:hsl(220, 10%, 40%);font-style:italic"># 第三层 (Hidden 2 -&gt; Output)</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">127</span><span>        self</span><span class="token" style="color:hsl(220, 14%, 71%)">.</span><span>Z3 </span><span class="token" style="color:hsl(207, 82%, 66%)">=</span><span> np</span><span class="token" style="color:hsl(220, 14%, 71%)">.</span><span>dot</span><span class="token" style="color:hsl(220, 14%, 71%)">(</span><span>self</span><span class="token" style="color:hsl(220, 14%, 71%)">.</span><span>A2</span><span class="token" style="color:hsl(220, 14%, 71%)">,</span><span> self</span><span class="token" style="color:hsl(220, 14%, 71%)">.</span><span>W3</span><span class="token" style="color:hsl(220, 14%, 71%)">)</span><span> </span><span class="token" style="color:hsl(207, 82%, 66%)">+</span><span> self</span><span class="token" style="color:hsl(220, 14%, 71%)">.</span><span>b3
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">128</span><span>        self</span><span class="token" style="color:hsl(220, 14%, 71%)">.</span><span>A3 </span><span class="token" style="color:hsl(207, 82%, 66%)">=</span><span> self</span><span class="token" style="color:hsl(220, 14%, 71%)">.</span><span>softmax</span><span class="token" style="color:hsl(220, 14%, 71%)">(</span><span>self</span><span class="token" style="color:hsl(220, 14%, 71%)">.</span><span>Z3</span><span class="token" style="color:hsl(220, 14%, 71%)">)</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">129</span>        
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">130</span><span>        </span><span class="token" style="color:hsl(286, 60%, 67%)">return</span><span> self</span><span class="token" style="color:hsl(220, 14%, 71%)">.</span><span>A3
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">131</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">132</span><span>    </span><span class="token" style="color:hsl(286, 60%, 67%)">def</span><span> </span><span class="token" style="color:hsl(207, 82%, 66%)">backward</span><span class="token" style="color:hsl(220, 14%, 71%)">(</span><span>self</span><span class="token" style="color:hsl(220, 14%, 71%)">,</span><span> X</span><span class="token" style="color:hsl(220, 14%, 71%)">,</span><span> y</span><span class="token" style="color:hsl(220, 14%, 71%)">)</span><span class="token" style="color:hsl(220, 14%, 71%)">:</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">133</span><span>        </span><span class="token triple-quoted-string" style="color:hsl(95, 38%, 62%)">&quot;&quot;&quot;反向传播 (BP算法核心)&quot;&quot;&quot;</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">134</span><span>        m </span><span class="token" style="color:hsl(207, 82%, 66%)">=</span><span> X</span><span class="token" style="color:hsl(220, 14%, 71%)">.</span><span>shape</span><span class="token" style="color:hsl(220, 14%, 71%)">[</span><span class="token" style="color:hsl(29, 54%, 61%)">0</span><span class="token" style="color:hsl(220, 14%, 71%)">]</span><span> </span><span class="token" style="color:hsl(220, 10%, 40%);font-style:italic"># 样本数量 (batch size)</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">135</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">136</span><span>        </span><span class="token" style="color:hsl(220, 10%, 40%);font-style:italic"># 1. 计算输出层误差 (Cross Entropy Loss + Softmax 的导数简化为 A3 - y)</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">137</span><span>        dZ3 </span><span class="token" style="color:hsl(207, 82%, 66%)">=</span><span> self</span><span class="token" style="color:hsl(220, 14%, 71%)">.</span><span>A3 </span><span class="token" style="color:hsl(207, 82%, 66%)">-</span><span> y
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">138</span>        
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">139</span><span>        </span><span class="token" style="color:hsl(220, 10%, 40%);font-style:italic"># 计算 W3 和 b3 的梯度</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">140</span><span>        dW3 </span><span class="token" style="color:hsl(207, 82%, 66%)">=</span><span> np</span><span class="token" style="color:hsl(220, 14%, 71%)">.</span><span>dot</span><span class="token" style="color:hsl(220, 14%, 71%)">(</span><span>self</span><span class="token" style="color:hsl(220, 14%, 71%)">.</span><span>A2</span><span class="token" style="color:hsl(220, 14%, 71%)">.</span><span>T</span><span class="token" style="color:hsl(220, 14%, 71%)">,</span><span> dZ3</span><span class="token" style="color:hsl(220, 14%, 71%)">)</span><span> </span><span class="token" style="color:hsl(207, 82%, 66%)">/</span><span> m
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">141</span><span>        db3 </span><span class="token" style="color:hsl(207, 82%, 66%)">=</span><span> np</span><span class="token" style="color:hsl(220, 14%, 71%)">.</span><span class="token" style="color:hsl(95, 38%, 62%)">sum</span><span class="token" style="color:hsl(220, 14%, 71%)">(</span><span>dZ3</span><span class="token" style="color:hsl(220, 14%, 71%)">,</span><span> axis</span><span class="token" style="color:hsl(207, 82%, 66%)">=</span><span class="token" style="color:hsl(29, 54%, 61%)">0</span><span class="token" style="color:hsl(220, 14%, 71%)">,</span><span> keepdims</span><span class="token" style="color:hsl(207, 82%, 66%)">=</span><span class="token" style="color:hsl(29, 54%, 61%)">True</span><span class="token" style="color:hsl(220, 14%, 71%)">)</span><span> </span><span class="token" style="color:hsl(207, 82%, 66%)">/</span><span> m
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">142</span>        
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">143</span><span>        </span><span class="token" style="color:hsl(220, 10%, 40%);font-style:italic"># 2. 计算隐藏层2的误差</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">144</span><span>        </span><span class="token" style="color:hsl(220, 10%, 40%);font-style:italic"># 链式法则: dZ2 = (dZ3 * W3.T) * sigmoid_derivative(A2)</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">145</span><span>        dA2 </span><span class="token" style="color:hsl(207, 82%, 66%)">=</span><span> np</span><span class="token" style="color:hsl(220, 14%, 71%)">.</span><span>dot</span><span class="token" style="color:hsl(220, 14%, 71%)">(</span><span>dZ3</span><span class="token" style="color:hsl(220, 14%, 71%)">,</span><span> self</span><span class="token" style="color:hsl(220, 14%, 71%)">.</span><span>W3</span><span class="token" style="color:hsl(220, 14%, 71%)">.</span><span>T</span><span class="token" style="color:hsl(220, 14%, 71%)">)</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">146</span><span>        dZ2 </span><span class="token" style="color:hsl(207, 82%, 66%)">=</span><span> dA2 </span><span class="token" style="color:hsl(207, 82%, 66%)">*</span><span> self</span><span class="token" style="color:hsl(220, 14%, 71%)">.</span><span>sigmoid_derivative</span><span class="token" style="color:hsl(220, 14%, 71%)">(</span><span>self</span><span class="token" style="color:hsl(220, 14%, 71%)">.</span><span>A2</span><span class="token" style="color:hsl(220, 14%, 71%)">)</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">147</span>        
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">148</span><span>        </span><span class="token" style="color:hsl(220, 10%, 40%);font-style:italic"># 计算 W2 和 b2 的梯度</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">149</span><span>        dW2 </span><span class="token" style="color:hsl(207, 82%, 66%)">=</span><span> np</span><span class="token" style="color:hsl(220, 14%, 71%)">.</span><span>dot</span><span class="token" style="color:hsl(220, 14%, 71%)">(</span><span>self</span><span class="token" style="color:hsl(220, 14%, 71%)">.</span><span>A1</span><span class="token" style="color:hsl(220, 14%, 71%)">.</span><span>T</span><span class="token" style="color:hsl(220, 14%, 71%)">,</span><span> dZ2</span><span class="token" style="color:hsl(220, 14%, 71%)">)</span><span> </span><span class="token" style="color:hsl(207, 82%, 66%)">/</span><span> m
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">150</span><span>        db2 </span><span class="token" style="color:hsl(207, 82%, 66%)">=</span><span> np</span><span class="token" style="color:hsl(220, 14%, 71%)">.</span><span class="token" style="color:hsl(95, 38%, 62%)">sum</span><span class="token" style="color:hsl(220, 14%, 71%)">(</span><span>dZ2</span><span class="token" style="color:hsl(220, 14%, 71%)">,</span><span> axis</span><span class="token" style="color:hsl(207, 82%, 66%)">=</span><span class="token" style="color:hsl(29, 54%, 61%)">0</span><span class="token" style="color:hsl(220, 14%, 71%)">,</span><span> keepdims</span><span class="token" style="color:hsl(207, 82%, 66%)">=</span><span class="token" style="color:hsl(29, 54%, 61%)">True</span><span class="token" style="color:hsl(220, 14%, 71%)">)</span><span> </span><span class="token" style="color:hsl(207, 82%, 66%)">/</span><span> m
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">151</span>        
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">152</span><span>        </span><span class="token" style="color:hsl(220, 10%, 40%);font-style:italic"># 3. 计算隐藏层1的误差</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">153</span><span>        dA1 </span><span class="token" style="color:hsl(207, 82%, 66%)">=</span><span> np</span><span class="token" style="color:hsl(220, 14%, 71%)">.</span><span>dot</span><span class="token" style="color:hsl(220, 14%, 71%)">(</span><span>dZ2</span><span class="token" style="color:hsl(220, 14%, 71%)">,</span><span> self</span><span class="token" style="color:hsl(220, 14%, 71%)">.</span><span>W2</span><span class="token" style="color:hsl(220, 14%, 71%)">.</span><span>T</span><span class="token" style="color:hsl(220, 14%, 71%)">)</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">154</span><span>        dZ1 </span><span class="token" style="color:hsl(207, 82%, 66%)">=</span><span> dA1 </span><span class="token" style="color:hsl(207, 82%, 66%)">*</span><span> self</span><span class="token" style="color:hsl(220, 14%, 71%)">.</span><span>sigmoid_derivative</span><span class="token" style="color:hsl(220, 14%, 71%)">(</span><span>self</span><span class="token" style="color:hsl(220, 14%, 71%)">.</span><span>A1</span><span class="token" style="color:hsl(220, 14%, 71%)">)</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">155</span>        
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">156</span><span>        </span><span class="token" style="color:hsl(220, 10%, 40%);font-style:italic"># 计算 W1 和 b1 的梯度</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">157</span><span>        dW1 </span><span class="token" style="color:hsl(207, 82%, 66%)">=</span><span> np</span><span class="token" style="color:hsl(220, 14%, 71%)">.</span><span>dot</span><span class="token" style="color:hsl(220, 14%, 71%)">(</span><span>X</span><span class="token" style="color:hsl(220, 14%, 71%)">.</span><span>T</span><span class="token" style="color:hsl(220, 14%, 71%)">,</span><span> dZ1</span><span class="token" style="color:hsl(220, 14%, 71%)">)</span><span> </span><span class="token" style="color:hsl(207, 82%, 66%)">/</span><span> m
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">158</span><span>        db1 </span><span class="token" style="color:hsl(207, 82%, 66%)">=</span><span> np</span><span class="token" style="color:hsl(220, 14%, 71%)">.</span><span class="token" style="color:hsl(95, 38%, 62%)">sum</span><span class="token" style="color:hsl(220, 14%, 71%)">(</span><span>dZ1</span><span class="token" style="color:hsl(220, 14%, 71%)">,</span><span> axis</span><span class="token" style="color:hsl(207, 82%, 66%)">=</span><span class="token" style="color:hsl(29, 54%, 61%)">0</span><span class="token" style="color:hsl(220, 14%, 71%)">,</span><span> keepdims</span><span class="token" style="color:hsl(207, 82%, 66%)">=</span><span class="token" style="color:hsl(29, 54%, 61%)">True</span><span class="token" style="color:hsl(220, 14%, 71%)">)</span><span> </span><span class="token" style="color:hsl(207, 82%, 66%)">/</span><span> m
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">159</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">160</span><span>        </span><span class="token" style="color:hsl(220, 10%, 40%);font-style:italic"># 4. 更新参数 (梯度下降)</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">161</span><span>        self</span><span class="token" style="color:hsl(220, 14%, 71%)">.</span><span>W3 </span><span class="token" style="color:hsl(207, 82%, 66%)">-=</span><span> self</span><span class="token" style="color:hsl(220, 14%, 71%)">.</span><span>lr </span><span class="token" style="color:hsl(207, 82%, 66%)">*</span><span> dW3
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">162</span><span>        self</span><span class="token" style="color:hsl(220, 14%, 71%)">.</span><span>b3 </span><span class="token" style="color:hsl(207, 82%, 66%)">-=</span><span> self</span><span class="token" style="color:hsl(220, 14%, 71%)">.</span><span>lr </span><span class="token" style="color:hsl(207, 82%, 66%)">*</span><span> db3
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">163</span><span>        self</span><span class="token" style="color:hsl(220, 14%, 71%)">.</span><span>W2 </span><span class="token" style="color:hsl(207, 82%, 66%)">-=</span><span> self</span><span class="token" style="color:hsl(220, 14%, 71%)">.</span><span>lr </span><span class="token" style="color:hsl(207, 82%, 66%)">*</span><span> dW2
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">164</span><span>        self</span><span class="token" style="color:hsl(220, 14%, 71%)">.</span><span>b2 </span><span class="token" style="color:hsl(207, 82%, 66%)">-=</span><span> self</span><span class="token" style="color:hsl(220, 14%, 71%)">.</span><span>lr </span><span class="token" style="color:hsl(207, 82%, 66%)">*</span><span> db2
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">165</span><span>        self</span><span class="token" style="color:hsl(220, 14%, 71%)">.</span><span>W1 </span><span class="token" style="color:hsl(207, 82%, 66%)">-=</span><span> self</span><span class="token" style="color:hsl(220, 14%, 71%)">.</span><span>lr </span><span class="token" style="color:hsl(207, 82%, 66%)">*</span><span> dW1
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">166</span><span>        self</span><span class="token" style="color:hsl(220, 14%, 71%)">.</span><span>b1 </span><span class="token" style="color:hsl(207, 82%, 66%)">-=</span><span> self</span><span class="token" style="color:hsl(220, 14%, 71%)">.</span><span>lr </span><span class="token" style="color:hsl(207, 82%, 66%)">*</span><span> db1
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">167</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">168</span><span>    </span><span class="token" style="color:hsl(286, 60%, 67%)">def</span><span> </span><span class="token" style="color:hsl(207, 82%, 66%)">compute_loss</span><span class="token" style="color:hsl(220, 14%, 71%)">(</span><span>self</span><span class="token" style="color:hsl(220, 14%, 71%)">,</span><span> y_pred</span><span class="token" style="color:hsl(220, 14%, 71%)">,</span><span> y_true</span><span class="token" style="color:hsl(220, 14%, 71%)">)</span><span class="token" style="color:hsl(220, 14%, 71%)">:</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">169</span><span>        </span><span class="token triple-quoted-string" style="color:hsl(95, 38%, 62%)">&quot;&quot;&quot;计算交叉熵损失&quot;&quot;&quot;</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">170</span><span>        m </span><span class="token" style="color:hsl(207, 82%, 66%)">=</span><span> y_true</span><span class="token" style="color:hsl(220, 14%, 71%)">.</span><span>shape</span><span class="token" style="color:hsl(220, 14%, 71%)">[</span><span class="token" style="color:hsl(29, 54%, 61%)">0</span><span class="token" style="color:hsl(220, 14%, 71%)">]</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">171</span><span>        </span><span class="token" style="color:hsl(220, 10%, 40%);font-style:italic"># 添加一个微小值 1e-9 防止 log(0)</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">172</span><span>        log_probs </span><span class="token" style="color:hsl(207, 82%, 66%)">=</span><span> </span><span class="token" style="color:hsl(207, 82%, 66%)">-</span><span>np</span><span class="token" style="color:hsl(220, 14%, 71%)">.</span><span>log</span><span class="token" style="color:hsl(220, 14%, 71%)">(</span><span>y_pred</span><span class="token" style="color:hsl(220, 14%, 71%)">[</span><span class="token" style="color:hsl(95, 38%, 62%)">range</span><span class="token" style="color:hsl(220, 14%, 71%)">(</span><span>m</span><span class="token" style="color:hsl(220, 14%, 71%)">)</span><span class="token" style="color:hsl(220, 14%, 71%)">,</span><span> np</span><span class="token" style="color:hsl(220, 14%, 71%)">.</span><span>argmax</span><span class="token" style="color:hsl(220, 14%, 71%)">(</span><span>y_true</span><span class="token" style="color:hsl(220, 14%, 71%)">,</span><span> axis</span><span class="token" style="color:hsl(207, 82%, 66%)">=</span><span class="token" style="color:hsl(29, 54%, 61%)">1</span><span class="token" style="color:hsl(220, 14%, 71%)">)</span><span class="token" style="color:hsl(220, 14%, 71%)">]</span><span> </span><span class="token" style="color:hsl(207, 82%, 66%)">+</span><span> </span><span class="token" style="color:hsl(29, 54%, 61%)">1e-9</span><span class="token" style="color:hsl(220, 14%, 71%)">)</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">173</span><span>        loss </span><span class="token" style="color:hsl(207, 82%, 66%)">=</span><span> np</span><span class="token" style="color:hsl(220, 14%, 71%)">.</span><span class="token" style="color:hsl(95, 38%, 62%)">sum</span><span class="token" style="color:hsl(220, 14%, 71%)">(</span><span>log_probs</span><span class="token" style="color:hsl(220, 14%, 71%)">)</span><span> </span><span class="token" style="color:hsl(207, 82%, 66%)">/</span><span> m
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">174</span><span>        </span><span class="token" style="color:hsl(286, 60%, 67%)">return</span><span> loss
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">175</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">176</span><span></span><span class="token" style="color:hsl(220, 10%, 40%);font-style:italic"># ==========================================</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">177</span><span></span><span class="token" style="color:hsl(220, 10%, 40%);font-style:italic"># 4. 训练与测试循环</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">178</span><span></span><span class="token" style="color:hsl(220, 10%, 40%);font-style:italic"># ==========================================</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">179</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">180</span><span></span><span class="token" style="color:hsl(220, 10%, 40%);font-style:italic"># 超参数设置</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">181</span><span>input_size </span><span class="token" style="color:hsl(207, 82%, 66%)">=</span><span> </span><span class="token" style="color:hsl(29, 54%, 61%)">784</span><span>    </span><span class="token" style="color:hsl(220, 10%, 40%);font-style:italic"># 28*28</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">182</span><span>hidden_size </span><span class="token" style="color:hsl(207, 82%, 66%)">=</span><span> </span><span class="token" style="color:hsl(29, 54%, 61%)">16</span><span>    </span><span class="token" style="color:hsl(220, 10%, 40%);font-style:italic"># 题目要求每层16个</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">183</span><span>output_size </span><span class="token" style="color:hsl(207, 82%, 66%)">=</span><span> </span><span class="token" style="color:hsl(29, 54%, 61%)">10</span><span>    </span><span class="token" style="color:hsl(220, 10%, 40%);font-style:italic"># 0-9 十个数字</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">184</span><span>learning_rate </span><span class="token" style="color:hsl(207, 82%, 66%)">=</span><span> </span><span class="token" style="color:hsl(29, 54%, 61%)">0.5</span><span> </span><span class="token" style="color:hsl(220, 10%, 40%);font-style:italic"># 学习率</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">185</span><span>epochs </span><span class="token" style="color:hsl(207, 82%, 66%)">=</span><span> </span><span class="token" style="color:hsl(29, 54%, 61%)">10</span><span>         </span><span class="token" style="color:hsl(220, 10%, 40%);font-style:italic"># 训练轮数</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">186</span><span>batch_size </span><span class="token" style="color:hsl(207, 82%, 66%)">=</span><span> </span><span class="token" style="color:hsl(29, 54%, 61%)">64</span><span>     </span><span class="token" style="color:hsl(220, 10%, 40%);font-style:italic"># 批量大小 (Mini-batch SGD)</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">187</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">188</span><span></span><span class="token" style="color:hsl(220, 10%, 40%);font-style:italic"># 初始化网络</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">189</span><span>nn </span><span class="token" style="color:hsl(207, 82%, 66%)">=</span><span> NeuralNetwork</span><span class="token" style="color:hsl(220, 14%, 71%)">(</span><span>input_size</span><span class="token" style="color:hsl(220, 14%, 71%)">,</span><span> hidden_size</span><span class="token" style="color:hsl(220, 14%, 71%)">,</span><span> output_size</span><span class="token" style="color:hsl(220, 14%, 71%)">,</span><span> learning_rate</span><span class="token" style="color:hsl(220, 14%, 71%)">)</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">190</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">191</span><span></span><span class="token" style="color:hsl(286, 60%, 67%)">print</span><span class="token" style="color:hsl(220, 14%, 71%)">(</span><span class="token string-interpolation" style="color:hsl(95, 38%, 62%)">f&quot;\n开始训练... (Epochs: </span><span class="token string-interpolation interpolation" style="color:hsl(220, 14%, 71%)">{</span><span class="token string-interpolation interpolation">epochs</span><span class="token string-interpolation interpolation" style="color:hsl(220, 14%, 71%)">}</span><span class="token string-interpolation" style="color:hsl(95, 38%, 62%)">, Batch Size: </span><span class="token string-interpolation interpolation" style="color:hsl(220, 14%, 71%)">{</span><span class="token string-interpolation interpolation">batch_size</span><span class="token string-interpolation interpolation" style="color:hsl(220, 14%, 71%)">}</span><span class="token string-interpolation" style="color:hsl(95, 38%, 62%)">, LR: </span><span class="token string-interpolation interpolation" style="color:hsl(220, 14%, 71%)">{</span><span class="token string-interpolation interpolation">learning_rate</span><span class="token string-interpolation interpolation" style="color:hsl(220, 14%, 71%)">}</span><span class="token string-interpolation" style="color:hsl(95, 38%, 62%)">)&quot;</span><span class="token" style="color:hsl(220, 14%, 71%)">)</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">192</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">193</span><span></span><span class="token" style="color:hsl(220, 10%, 40%);font-style:italic"># 训练循环</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">194</span><span></span><span class="token" style="color:hsl(286, 60%, 67%)">for</span><span> epoch </span><span class="token" style="color:hsl(286, 60%, 67%)">in</span><span> </span><span class="token" style="color:hsl(95, 38%, 62%)">range</span><span class="token" style="color:hsl(220, 14%, 71%)">(</span><span>epochs</span><span class="token" style="color:hsl(220, 14%, 71%)">)</span><span class="token" style="color:hsl(220, 14%, 71%)">:</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">195</span><span>    </span><span class="token" style="color:hsl(220, 10%, 40%);font-style:italic"># 打乱数据</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">196</span><span>    permutation </span><span class="token" style="color:hsl(207, 82%, 66%)">=</span><span> np</span><span class="token" style="color:hsl(220, 14%, 71%)">.</span><span>random</span><span class="token" style="color:hsl(220, 14%, 71%)">.</span><span>permutation</span><span class="token" style="color:hsl(220, 14%, 71%)">(</span><span>X_train</span><span class="token" style="color:hsl(220, 14%, 71%)">.</span><span>shape</span><span class="token" style="color:hsl(220, 14%, 71%)">[</span><span class="token" style="color:hsl(29, 54%, 61%)">0</span><span class="token" style="color:hsl(220, 14%, 71%)">]</span><span class="token" style="color:hsl(220, 14%, 71%)">)</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">197</span><span>    X_train_shuffled </span><span class="token" style="color:hsl(207, 82%, 66%)">=</span><span> X_train</span><span class="token" style="color:hsl(220, 14%, 71%)">[</span><span>permutation</span><span class="token" style="color:hsl(220, 14%, 71%)">]</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">198</span><span>    y_train_shuffled </span><span class="token" style="color:hsl(207, 82%, 66%)">=</span><span> y_train</span><span class="token" style="color:hsl(220, 14%, 71%)">[</span><span>permutation</span><span class="token" style="color:hsl(220, 14%, 71%)">]</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">199</span>    
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">200</span><span>    </span><span class="token" style="color:hsl(286, 60%, 67%)">for</span><span> i </span><span class="token" style="color:hsl(286, 60%, 67%)">in</span><span> </span><span class="token" style="color:hsl(95, 38%, 62%)">range</span><span class="token" style="color:hsl(220, 14%, 71%)">(</span><span class="token" style="color:hsl(29, 54%, 61%)">0</span><span class="token" style="color:hsl(220, 14%, 71%)">,</span><span> X_train</span><span class="token" style="color:hsl(220, 14%, 71%)">.</span><span>shape</span><span class="token" style="color:hsl(220, 14%, 71%)">[</span><span class="token" style="color:hsl(29, 54%, 61%)">0</span><span class="token" style="color:hsl(220, 14%, 71%)">]</span><span class="token" style="color:hsl(220, 14%, 71%)">,</span><span> batch_size</span><span class="token" style="color:hsl(220, 14%, 71%)">)</span><span class="token" style="color:hsl(220, 14%, 71%)">:</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">201</span><span>        </span><span class="token" style="color:hsl(220, 10%, 40%);font-style:italic"># 获取当前 batch</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">202</span><span>        X_batch </span><span class="token" style="color:hsl(207, 82%, 66%)">=</span><span> X_train_shuffled</span><span class="token" style="color:hsl(220, 14%, 71%)">[</span><span>i</span><span class="token" style="color:hsl(220, 14%, 71%)">:</span><span>i</span><span class="token" style="color:hsl(207, 82%, 66%)">+</span><span>batch_size</span><span class="token" style="color:hsl(220, 14%, 71%)">]</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">203</span><span>        y_batch </span><span class="token" style="color:hsl(207, 82%, 66%)">=</span><span> y_train_shuffled</span><span class="token" style="color:hsl(220, 14%, 71%)">[</span><span>i</span><span class="token" style="color:hsl(220, 14%, 71%)">:</span><span>i</span><span class="token" style="color:hsl(207, 82%, 66%)">+</span><span>batch_size</span><span class="token" style="color:hsl(220, 14%, 71%)">]</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">204</span>        
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">205</span><span>        </span><span class="token" style="color:hsl(220, 10%, 40%);font-style:italic"># 前向传播</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">206</span><span>        output </span><span class="token" style="color:hsl(207, 82%, 66%)">=</span><span> nn</span><span class="token" style="color:hsl(220, 14%, 71%)">.</span><span>forward</span><span class="token" style="color:hsl(220, 14%, 71%)">(</span><span>X_batch</span><span class="token" style="color:hsl(220, 14%, 71%)">)</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">207</span>        
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">208</span><span>        </span><span class="token" style="color:hsl(220, 10%, 40%);font-style:italic"># 反向传播并更新权重</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">209</span><span>        nn</span><span class="token" style="color:hsl(220, 14%, 71%)">.</span><span>backward</span><span class="token" style="color:hsl(220, 14%, 71%)">(</span><span>X_batch</span><span class="token" style="color:hsl(220, 14%, 71%)">,</span><span> y_batch</span><span class="token" style="color:hsl(220, 14%, 71%)">)</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">210</span>    
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">211</span><span>    </span><span class="token" style="color:hsl(220, 10%, 40%);font-style:italic"># 每个 Epoch 结束后评估一次</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">212</span><span>    train_output </span><span class="token" style="color:hsl(207, 82%, 66%)">=</span><span> nn</span><span class="token" style="color:hsl(220, 14%, 71%)">.</span><span>forward</span><span class="token" style="color:hsl(220, 14%, 71%)">(</span><span>X_train</span><span class="token" style="color:hsl(220, 14%, 71%)">)</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">213</span><span>    loss </span><span class="token" style="color:hsl(207, 82%, 66%)">=</span><span> nn</span><span class="token" style="color:hsl(220, 14%, 71%)">.</span><span>compute_loss</span><span class="token" style="color:hsl(220, 14%, 71%)">(</span><span>train_output</span><span class="token" style="color:hsl(220, 14%, 71%)">,</span><span> y_train</span><span class="token" style="color:hsl(220, 14%, 71%)">)</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">214</span>    
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">215</span><span>    </span><span class="token" style="color:hsl(220, 10%, 40%);font-style:italic"># 计算准确率</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">216</span><span>    predictions </span><span class="token" style="color:hsl(207, 82%, 66%)">=</span><span> np</span><span class="token" style="color:hsl(220, 14%, 71%)">.</span><span>argmax</span><span class="token" style="color:hsl(220, 14%, 71%)">(</span><span>train_output</span><span class="token" style="color:hsl(220, 14%, 71%)">,</span><span> axis</span><span class="token" style="color:hsl(207, 82%, 66%)">=</span><span class="token" style="color:hsl(29, 54%, 61%)">1</span><span class="token" style="color:hsl(220, 14%, 71%)">)</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">217</span><span>    labels </span><span class="token" style="color:hsl(207, 82%, 66%)">=</span><span> np</span><span class="token" style="color:hsl(220, 14%, 71%)">.</span><span>argmax</span><span class="token" style="color:hsl(220, 14%, 71%)">(</span><span>y_train</span><span class="token" style="color:hsl(220, 14%, 71%)">,</span><span> axis</span><span class="token" style="color:hsl(207, 82%, 66%)">=</span><span class="token" style="color:hsl(29, 54%, 61%)">1</span><span class="token" style="color:hsl(220, 14%, 71%)">)</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">218</span><span>    accuracy </span><span class="token" style="color:hsl(207, 82%, 66%)">=</span><span> np</span><span class="token" style="color:hsl(220, 14%, 71%)">.</span><span>mean</span><span class="token" style="color:hsl(220, 14%, 71%)">(</span><span>predictions </span><span class="token" style="color:hsl(207, 82%, 66%)">==</span><span> labels</span><span class="token" style="color:hsl(220, 14%, 71%)">)</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">219</span>    
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">220</span><span>    </span><span class="token" style="color:hsl(286, 60%, 67%)">print</span><span class="token" style="color:hsl(220, 14%, 71%)">(</span><span class="token string-interpolation" style="color:hsl(95, 38%, 62%)">f&quot;Epoch </span><span class="token string-interpolation interpolation" style="color:hsl(220, 14%, 71%)">{</span><span class="token string-interpolation interpolation">epoch</span><span class="token string-interpolation interpolation" style="color:hsl(207, 82%, 66%)">+</span><span class="token string-interpolation interpolation" style="color:hsl(29, 54%, 61%)">1</span><span class="token string-interpolation interpolation" style="color:hsl(220, 14%, 71%)">}</span><span class="token string-interpolation" style="color:hsl(95, 38%, 62%)">/</span><span class="token string-interpolation interpolation" style="color:hsl(220, 14%, 71%)">{</span><span class="token string-interpolation interpolation">epochs</span><span class="token string-interpolation interpolation" style="color:hsl(220, 14%, 71%)">}</span><span class="token string-interpolation" style="color:hsl(95, 38%, 62%)"> - Loss: </span><span class="token string-interpolation interpolation" style="color:hsl(220, 14%, 71%)">{</span><span class="token string-interpolation interpolation">loss</span><span class="token string-interpolation interpolation" style="color:hsl(220, 14%, 71%)">:</span><span class="token string-interpolation interpolation format-spec">.4f</span><span class="token string-interpolation interpolation" style="color:hsl(220, 14%, 71%)">}</span><span class="token string-interpolation" style="color:hsl(95, 38%, 62%)"> - Accuracy: </span><span class="token string-interpolation interpolation" style="color:hsl(220, 14%, 71%)">{</span><span class="token string-interpolation interpolation">accuracy</span><span class="token string-interpolation interpolation" style="color:hsl(220, 14%, 71%)">:</span><span class="token string-interpolation interpolation format-spec">.4f</span><span class="token string-interpolation interpolation" style="color:hsl(220, 14%, 71%)">}</span><span class="token string-interpolation" style="color:hsl(95, 38%, 62%)">&quot;</span><span class="token" style="color:hsl(220, 14%, 71%)">)</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">221</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">222</span><span></span><span class="token" style="color:hsl(220, 10%, 40%);font-style:italic"># ==========================================</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">223</span><span></span><span class="token" style="color:hsl(220, 10%, 40%);font-style:italic"># 5. 最终测试集验证</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">224</span><span></span><span class="token" style="color:hsl(220, 10%, 40%);font-style:italic"># ==========================================</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">225</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">226</span><span></span><span class="token" style="color:hsl(286, 60%, 67%)">print</span><span class="token" style="color:hsl(220, 14%, 71%)">(</span><span class="token" style="color:hsl(95, 38%, 62%)">&quot;\n正在测试集上评估...&quot;</span><span class="token" style="color:hsl(220, 14%, 71%)">)</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">227</span><span>test_output </span><span class="token" style="color:hsl(207, 82%, 66%)">=</span><span> nn</span><span class="token" style="color:hsl(220, 14%, 71%)">.</span><span>forward</span><span class="token" style="color:hsl(220, 14%, 71%)">(</span><span>X_test</span><span class="token" style="color:hsl(220, 14%, 71%)">)</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">228</span><span>test_predictions </span><span class="token" style="color:hsl(207, 82%, 66%)">=</span><span> np</span><span class="token" style="color:hsl(220, 14%, 71%)">.</span><span>argmax</span><span class="token" style="color:hsl(220, 14%, 71%)">(</span><span>test_output</span><span class="token" style="color:hsl(220, 14%, 71%)">,</span><span> axis</span><span class="token" style="color:hsl(207, 82%, 66%)">=</span><span class="token" style="color:hsl(29, 54%, 61%)">1</span><span class="token" style="color:hsl(220, 14%, 71%)">)</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">229</span><span>test_labels </span><span class="token" style="color:hsl(207, 82%, 66%)">=</span><span> np</span><span class="token" style="color:hsl(220, 14%, 71%)">.</span><span>argmax</span><span class="token" style="color:hsl(220, 14%, 71%)">(</span><span>y_test</span><span class="token" style="color:hsl(220, 14%, 71%)">,</span><span> axis</span><span class="token" style="color:hsl(207, 82%, 66%)">=</span><span class="token" style="color:hsl(29, 54%, 61%)">1</span><span class="token" style="color:hsl(220, 14%, 71%)">)</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">230</span><span>test_acc </span><span class="token" style="color:hsl(207, 82%, 66%)">=</span><span> np</span><span class="token" style="color:hsl(220, 14%, 71%)">.</span><span>mean</span><span class="token" style="color:hsl(220, 14%, 71%)">(</span><span>test_predictions </span><span class="token" style="color:hsl(207, 82%, 66%)">==</span><span> test_labels</span><span class="token" style="color:hsl(220, 14%, 71%)">)</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">231</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">232</span><span></span><span class="token" style="color:hsl(286, 60%, 67%)">print</span><span class="token" style="color:hsl(220, 14%, 71%)">(</span><span class="token string-interpolation" style="color:hsl(95, 38%, 62%)">f&quot;测试集最终准确率: </span><span class="token string-interpolation interpolation" style="color:hsl(220, 14%, 71%)">{</span><span class="token string-interpolation interpolation">test_acc </span><span class="token string-interpolation interpolation" style="color:hsl(207, 82%, 66%)">*</span><span class="token string-interpolation interpolation"> </span><span class="token string-interpolation interpolation" style="color:hsl(29, 54%, 61%)">100</span><span class="token string-interpolation interpolation" style="color:hsl(220, 14%, 71%)">:</span><span class="token string-interpolation interpolation format-spec">.2f</span><span class="token string-interpolation interpolation" style="color:hsl(220, 14%, 71%)">}</span><span class="token string-interpolation" style="color:hsl(95, 38%, 62%)">%&quot;</span><span class="token" style="color:hsl(220, 14%, 71%)">)</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">233</span>
<span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">234</span><span></span><span class="token" style="color:hsl(220, 10%, 40%);font-style:italic"># 随机挑几个测试集图片看看预测结果</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">235</span><span></span><span class="token" style="color:hsl(286, 60%, 67%)">print</span><span class="token" style="color:hsl(220, 14%, 71%)">(</span><span class="token" style="color:hsl(95, 38%, 62%)">&quot;\n随机抽取测试集预测展示:&quot;</span><span class="token" style="color:hsl(220, 14%, 71%)">)</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">236</span><span>indices </span><span class="token" style="color:hsl(207, 82%, 66%)">=</span><span> np</span><span class="token" style="color:hsl(220, 14%, 71%)">.</span><span>random</span><span class="token" style="color:hsl(220, 14%, 71%)">.</span><span>choice</span><span class="token" style="color:hsl(220, 14%, 71%)">(</span><span class="token" style="color:hsl(95, 38%, 62%)">len</span><span class="token" style="color:hsl(220, 14%, 71%)">(</span><span>X_test</span><span class="token" style="color:hsl(220, 14%, 71%)">)</span><span class="token" style="color:hsl(220, 14%, 71%)">,</span><span> </span><span class="token" style="color:hsl(29, 54%, 61%)">5</span><span class="token" style="color:hsl(220, 14%, 71%)">,</span><span> replace</span><span class="token" style="color:hsl(207, 82%, 66%)">=</span><span class="token" style="color:hsl(29, 54%, 61%)">False</span><span class="token" style="color:hsl(220, 14%, 71%)">)</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">237</span><span>plt</span><span class="token" style="color:hsl(220, 14%, 71%)">.</span><span>figure</span><span class="token" style="color:hsl(220, 14%, 71%)">(</span><span>figsize</span><span class="token" style="color:hsl(207, 82%, 66%)">=</span><span class="token" style="color:hsl(220, 14%, 71%)">(</span><span class="token" style="color:hsl(29, 54%, 61%)">10</span><span class="token" style="color:hsl(220, 14%, 71%)">,</span><span> </span><span class="token" style="color:hsl(29, 54%, 61%)">3</span><span class="token" style="color:hsl(220, 14%, 71%)">)</span><span class="token" style="color:hsl(220, 14%, 71%)">)</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">238</span><span></span><span class="token" style="color:hsl(286, 60%, 67%)">for</span><span> i</span><span class="token" style="color:hsl(220, 14%, 71%)">,</span><span> idx </span><span class="token" style="color:hsl(286, 60%, 67%)">in</span><span> </span><span class="token" style="color:hsl(95, 38%, 62%)">enumerate</span><span class="token" style="color:hsl(220, 14%, 71%)">(</span><span>indices</span><span class="token" style="color:hsl(220, 14%, 71%)">)</span><span class="token" style="color:hsl(220, 14%, 71%)">:</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">239</span><span>    plt</span><span class="token" style="color:hsl(220, 14%, 71%)">.</span><span>subplot</span><span class="token" style="color:hsl(220, 14%, 71%)">(</span><span class="token" style="color:hsl(29, 54%, 61%)">1</span><span class="token" style="color:hsl(220, 14%, 71%)">,</span><span> </span><span class="token" style="color:hsl(29, 54%, 61%)">5</span><span class="token" style="color:hsl(220, 14%, 71%)">,</span><span> i </span><span class="token" style="color:hsl(207, 82%, 66%)">+</span><span> </span><span class="token" style="color:hsl(29, 54%, 61%)">1</span><span class="token" style="color:hsl(220, 14%, 71%)">)</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">240</span><span>    img </span><span class="token" style="color:hsl(207, 82%, 66%)">=</span><span> X_test</span><span class="token" style="color:hsl(220, 14%, 71%)">[</span><span>idx</span><span class="token" style="color:hsl(220, 14%, 71%)">]</span><span class="token" style="color:hsl(220, 14%, 71%)">.</span><span>reshape</span><span class="token" style="color:hsl(220, 14%, 71%)">(</span><span class="token" style="color:hsl(29, 54%, 61%)">28</span><span class="token" style="color:hsl(220, 14%, 71%)">,</span><span> </span><span class="token" style="color:hsl(29, 54%, 61%)">28</span><span class="token" style="color:hsl(220, 14%, 71%)">)</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">241</span><span>    plt</span><span class="token" style="color:hsl(220, 14%, 71%)">.</span><span>imshow</span><span class="token" style="color:hsl(220, 14%, 71%)">(</span><span>img</span><span class="token" style="color:hsl(220, 14%, 71%)">,</span><span> cmap</span><span class="token" style="color:hsl(207, 82%, 66%)">=</span><span class="token" style="color:hsl(95, 38%, 62%)">&#x27;gray&#x27;</span><span class="token" style="color:hsl(220, 14%, 71%)">)</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">242</span><span>    pred </span><span class="token" style="color:hsl(207, 82%, 66%)">=</span><span> test_predictions</span><span class="token" style="color:hsl(220, 14%, 71%)">[</span><span>idx</span><span class="token" style="color:hsl(220, 14%, 71%)">]</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">243</span><span>    true_label </span><span class="token" style="color:hsl(207, 82%, 66%)">=</span><span> test_labels</span><span class="token" style="color:hsl(220, 14%, 71%)">[</span><span>idx</span><span class="token" style="color:hsl(220, 14%, 71%)">]</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">244</span><span>    plt</span><span class="token" style="color:hsl(220, 14%, 71%)">.</span><span>title</span><span class="token" style="color:hsl(220, 14%, 71%)">(</span><span class="token string-interpolation" style="color:hsl(95, 38%, 62%)">f&quot;Pred: </span><span class="token string-interpolation interpolation" style="color:hsl(220, 14%, 71%)">{</span><span class="token string-interpolation interpolation">pred</span><span class="token string-interpolation interpolation" style="color:hsl(220, 14%, 71%)">}</span><span class="token string-interpolation" style="color:hsl(95, 38%, 62%)">\nTrue: </span><span class="token string-interpolation interpolation" style="color:hsl(220, 14%, 71%)">{</span><span class="token string-interpolation interpolation">true_label</span><span class="token string-interpolation interpolation" style="color:hsl(220, 14%, 71%)">}</span><span class="token string-interpolation" style="color:hsl(95, 38%, 62%)">&quot;</span><span class="token" style="color:hsl(220, 14%, 71%)">,</span><span> color</span><span class="token" style="color:hsl(207, 82%, 66%)">=</span><span class="token" style="color:hsl(220, 14%, 71%)">(</span><span class="token" style="color:hsl(95, 38%, 62%)">&quot;green&quot;</span><span> </span><span class="token" style="color:hsl(286, 60%, 67%)">if</span><span> pred</span><span class="token" style="color:hsl(207, 82%, 66%)">==</span><span>true_label </span><span class="token" style="color:hsl(286, 60%, 67%)">else</span><span> </span><span class="token" style="color:hsl(95, 38%, 62%)">&quot;red&quot;</span><span class="token" style="color:hsl(220, 14%, 71%)">)</span><span class="token" style="color:hsl(220, 14%, 71%)">)</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">245</span><span>    plt</span><span class="token" style="color:hsl(220, 14%, 71%)">.</span><span>axis</span><span class="token" style="color:hsl(220, 14%, 71%)">(</span><span class="token" style="color:hsl(95, 38%, 62%)">&#x27;off&#x27;</span><span class="token" style="color:hsl(220, 14%, 71%)">)</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">246</span><span>plt</span><span class="token" style="color:hsl(220, 14%, 71%)">.</span><span>show</span><span class="token" style="color:hsl(220, 14%, 71%)">(</span><span class="token" style="color:hsl(220, 14%, 71%)">)</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:4.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">247</span></code></div></div></div></pre>
<h3>代码原理解析（辅助学习）</h3>
<ol>
<li>
<p><strong>数据读取 (<code class="bg-chatbox-background-secondary border border-solid border-chatbox-border-secondary rounded-sm px-1 py-0.5 mx-1">load_mnist_images</code>)</strong>:</p>
<ul>
<li>MNIST 文件是二进制文件。我们需要跳过头部信息（Offset 16 字节），然后读取剩下的数据。</li>
<li><strong>关键点</strong>：<code class="bg-chatbox-background-secondary border border-solid border-chatbox-border-secondary rounded-sm px-1 py-0.5 mx-1">reshape(-1, 784)</code> 将 28x28 的二维图片拉平成一条长的一维向量（长度784），这是最简单的全连接神经网络（MLP）所需要的输入格式。</li>
<li><strong>归一化</strong>：除以 255.0 将像素值变成 0 到 1 之间。如果不做这一步，Sigmoid 函数会饱和（输出全为0或1），导致梯度消失，网络无法训练。</li>
</ul>
</li>
<li>
<p><strong>网络结构 (<code class="bg-chatbox-background-secondary border border-solid border-chatbox-border-secondary rounded-sm px-1 py-0.5 mx-1">__init__</code>)</strong>:</p>
<ul>
<li><strong>输入层</strong>: 784 个神经元。</li>
<li><strong>隐藏层1</strong>: 16 个神经元（题目要求）。</li>
<li><strong>隐藏层2</strong>: 16 个神经元（题目要求）。</li>
<li><strong>输出层</strong>: 10 个神经元（对应数字 0-9 的概率）。</li>
<li><strong>权重初始化</strong>: 使用随机数乘以 0.01。如果权重初始化为0，网络无法学习；如果太大，容易梯度爆炸或消失。</li>
</ul>
</li>
<li>
<p><strong>激活函数</strong>:</p>
<ul>
<li><strong>Sigmoid</strong>: 用于隐藏层，将数值压缩到 (0, 1) 区间，引入非线性。</li>
<li><strong>Softmax</strong>: 专门用于输出层。它将输出的10个数值转换为“概率分布”，所有概率加起来等于1。</li>
</ul>
</li>
<li>
<p><strong>前向传播 (<code class="bg-chatbox-background-secondary border border-solid border-chatbox-border-secondary rounded-sm px-1 py-0.5 mx-1">forward</code>)</strong>:</p>
<ul>
<li>本质就是矩阵乘法：<code class="bg-chatbox-background-secondary border border-solid border-chatbox-border-secondary rounded-sm px-1 py-0.5 mx-1">输入 * 权重 + 偏置</code>，然后过激活函数。</li>
<li>公式：<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>A</mi><mo>=</mo><mi>σ</mi><mo stretchy="false">(</mo><mi>X</mi><mo>⋅</mo><mi>W</mi><mo>+</mo><mi>b</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">A = \sigma(X \cdot W + b)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em"></span><span class="mord mathnormal">A</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord mathnormal" style="margin-right:0.03588em">σ</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.07847em">X</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:0.7667em;vertical-align:-0.0833em"></span><span class="mord mathnormal" style="margin-right:0.13889em">W</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord mathnormal">b</span><span class="mclose">)</span></span></span></span></li>
</ul>
</li>
<li>
<p><strong>反向传播 (<code class="bg-chatbox-background-secondary border border-solid border-chatbox-border-secondary rounded-sm px-1 py-0.5 mx-1">backward</code>)</strong>:</p>
<ul>
<li>这是最难理解的部分。简单来说，我们计算预测值和真实值的差距（Loss）。</li>
<li>然后利用<strong>链式法则</strong>，从后往前推导，计算每个权重参数对误差的贡献（梯度）。</li>
<li>最后用<strong>梯度下降</strong>公式更新权重：<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>W</mi><mo>=</mo><mi>W</mi><mo>−</mo><mtext>学习率</mtext><mo>×</mo><mtext>梯度</mtext></mrow><annotation encoding="application/x-tex">W = W - \text{学习率} \times \text{梯度}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em"></span><span class="mord mathnormal" style="margin-right:0.13889em">W</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:0.7667em;vertical-align:-0.0833em"></span><span class="mord mathnormal" style="margin-right:0.13889em">W</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:0.7667em;vertical-align:-0.0833em"></span><span class="mord text"><span class="mord cjk_fallback">学习率</span></span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:0.6833em"></span><span class="mord text"><span class="mord cjk_fallback">梯度</span></span></span></span></span>。</li>
</ul>
</li>
</ol>
<h3>预期结果</h3>
<p>由于网络结构比较简单（中间只有16个神经元，这对于MNIST来说有点“窄”），但训练10轮后，准确率通常能达到 <strong>90% - 94%</strong> 左右。这对于入门理解 BP 神经网络已经非常足够了。</p></div></div>
<div class="mb-4">
<p class="text-green-500 text-lg"><b>USER: </b></p>
<style data-mantine-styles="classes">@media (max-width: 35.99375em) {.mantine-visible-from-xs {display: none !important;}}@media (min-width: 36em) {.mantine-hidden-from-xs {display: none !important;}}@media (max-width: 47.99375em) {.mantine-visible-from-sm {display: none !important;}}@media (min-width: 48em) {.mantine-hidden-from-sm {display: none !important;}}@media (max-width: 61.99375em) {.mantine-visible-from-md {display: none !important;}}@media (min-width: 62em) {.mantine-hidden-from-md {display: none !important;}}@media (max-width: 74.99375em) {.mantine-visible-from-lg {display: none !important;}}@media (min-width: 75em) {.mantine-hidden-from-lg {display: none !important;}}@media (max-width: 87.99375em) {.mantine-visible-from-xl {display: none !important;}}@media (min-width: 88em) {.mantine-hidden-from-xl {display: none !important;}}</style><div class="break-words "><p>我需要你详细解释一下def backward(self, X, y):这个函数。我知道A2是第第二层的激活值，但是不太理解的是A2.T和A3.T代表什么？以及最关键的求导，比如dZ3是损失函数对Z3的求导吗？以及为什么最后的表达式是这样<br/>
dZ3 = self.A3 - y<br/>
还有这样<br/>
dW3 = np.dot(self.A2.T, dZ3) / m<br/>
db3 = np.sum(dZ3, axis=0, keepdims=True) / m<br/>
为什么要除以M我需要你给出数学的推到过程</p></div></div>
<div class="mb-4">
<p class="text-blue-500 text-lg"><b>ASSISTANT: </b></p>
<style data-mantine-styles="classes">@media (max-width: 35.99375em) {.mantine-visible-from-xs {display: none !important;}}@media (min-width: 36em) {.mantine-hidden-from-xs {display: none !important;}}@media (max-width: 47.99375em) {.mantine-visible-from-sm {display: none !important;}}@media (min-width: 48em) {.mantine-hidden-from-sm {display: none !important;}}@media (max-width: 61.99375em) {.mantine-visible-from-md {display: none !important;}}@media (min-width: 62em) {.mantine-hidden-from-md {display: none !important;}}@media (max-width: 74.99375em) {.mantine-visible-from-lg {display: none !important;}}@media (min-width: 75em) {.mantine-hidden-from-lg {display: none !important;}}@media (max-width: 87.99375em) {.mantine-visible-from-xl {display: none !important;}}@media (min-width: 88em) {.mantine-hidden-from-xl {display: none !important;}}</style><div class="break-words "><p>这确实是神经网络中最核心、也是最难理解的部分。只要弄懂了<code class="bg-chatbox-background-secondary border border-solid border-chatbox-border-secondary rounded-sm px-1 py-0.5 mx-1">backward</code>，你就弄懂了神经网络的本质。</p>
<p>我们分三个部分来详细拆解：<strong>符号含义</strong>、<strong>数学推导（为什么是减法）</strong>、<strong>矩阵运算（为什么要转置和除以m）</strong>。</p>
<h3>1. 基础符号与 <code class="bg-chatbox-background-secondary border border-solid border-chatbox-border-secondary rounded-sm px-1 py-0.5 mx-1">.T</code> 的含义</h3>
<p>首先回答你关于 <code class="bg-chatbox-background-secondary border border-solid border-chatbox-border-secondary rounded-sm px-1 py-0.5 mx-1">.T</code> 的问题：</p>
<ul>
<li>在 NumPy 中，<code class="bg-chatbox-background-secondary border border-solid border-chatbox-border-secondary rounded-sm px-1 py-0.5 mx-1">.T</code> 表示<strong>矩阵转置</strong>（Transpose）。</li>
<li><strong>为什么要转置？</strong> 为了满足矩阵乘法的维度要求。矩阵乘法 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>A</mi><mo>×</mo><mi>B</mi></mrow><annotation encoding="application/x-tex">A \times B</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7667em;vertical-align:-0.0833em"></span><span class="mord mathnormal">A</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:0.6833em"></span><span class="mord mathnormal" style="margin-right:0.05017em">B</span></span></span></span> 要求 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>A</mi></mrow><annotation encoding="application/x-tex">A</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em"></span><span class="mord mathnormal">A</span></span></span></span> 的列数等于 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>B</mi></mrow><annotation encoding="application/x-tex">B</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em"></span><span class="mord mathnormal" style="margin-right:0.05017em">B</span></span></span></span> 的行数。在反向传播计算梯度时，为了把形状对齐，我们经常需要把矩阵转置过来。</li>
</ul>
<h3>2. 为什么 <code class="bg-chatbox-background-secondary border border-solid border-chatbox-border-secondary rounded-sm px-1 py-0.5 mx-1">dZ3 = self.A3 - y</code>？</h3>
<p>这行代码看起来简单得不可思议，但它背后是<strong>交叉熵损失函数（Cross Entropy Loss）<strong>配合</strong>Softmax激活函数</strong>求导后的完美化简结果。</p>
<p><strong>数学推导过程：</strong></p>
<ol>
<li>
<p><strong>定义输出</strong>：</p>
<ul>
<li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>z</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">z_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.04398em">z</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em"><span style="top:-2.55em;margin-left:-0.044em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span></span></span></span> 是输出层第 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6595em"></span><span class="mord mathnormal">i</span></span></span></span> 个神经元的线性输出（还没经过Softmax）。</li>
<li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>a</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">a_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em"></span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span></span></span></span> 是经过 Softmax 后的概率：<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>a</mi><mi>i</mi></msub><mo>=</mo><mfrac><msup><mi>e</mi><msub><mi>z</mi><mi>i</mi></msub></msup><mrow><mo>∑</mo><msup><mi>e</mi><msub><mi>z</mi><mi>k</mi></msub></msup></mrow></mfrac></mrow><annotation encoding="application/x-tex">a_i = \frac{e^{z_i}}{\sum e^{z_k}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em"></span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:1.431em;vertical-align:-0.52em"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.911em"><span style="top:-2.655em"><span class="pstrut" style="height:3em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mop op-symbol small-op mtight" style="position:relative;top:0em">∑</span><span class="mspace mtight" style="margin-right:0.1952em"></span><span class="mord mtight"><span class="mord mathnormal mtight">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.665em"><span style="top:-2.8575em;margin-right:0.0714em"><span class="pstrut" style="height:2.5em"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.04398em">z</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em"><span style="top:-2.3448em;margin-left:-0.044em;margin-right:0.1em"><span class="pstrut" style="height:2.6944em"></span><span class="mord mathnormal mtight" style="margin-right:0.03148em">k</span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.3496em"><span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em"><span class="pstrut" style="height:3em"></span><span class="frac-line" style="border-bottom-width:0.04em"></span></span><span style="top:-3.394em"><span class="pstrut" style="height:3em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7385em"><span style="top:-2.931em;margin-right:0.0714em"><span class="pstrut" style="height:2.5em"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.04398em">z</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em"><span style="top:-2.3448em;margin-left:-0.044em;margin-right:0.1em"><span class="pstrut" style="height:2.6595em"></span><span class="mord mathnormal mtight">i</span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.3147em"><span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.52em"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span>。</li>
<li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>y</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">y_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span></span></span></span> 是真实标签（One-hot编码，真实的那个类别为1，其他为0）。</li>
</ul>
</li>
<li>
<p><strong>定义损失函数 (Loss)</strong>：<br/>
交叉熵损失函数针对单个样本的公式是：<br/>
<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>L</mi><mo>=</mo><mo>−</mo><msub><mo>∑</mo><mi>k</mi></msub><msub><mi>y</mi><mi>k</mi></msub><mi>ln</mi><mo>⁡</mo><mo stretchy="false">(</mo><msub><mi>a</mi><mi>k</mi></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">L = - \sum_{k} y_k \ln(a_k)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em"></span><span class="mord mathnormal">L</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:1.0497em;vertical-align:-0.2997em"></span><span class="mord">−</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1864em"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em">k</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2997em"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em"></span><span class="mop">ln</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></p>
</li>
<li>
<p><strong>求导目标</strong>：<br/>
我们要算的是损失函数 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>L</mi></mrow><annotation encoding="application/x-tex">L</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em"></span><span class="mord mathnormal">L</span></span></span></span> 对线性输出 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>z</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">z_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.04398em">z</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em"><span style="top:-2.55em;margin-left:-0.044em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span></span></span></span> 的导数，也就是代码中的 <code class="bg-chatbox-background-secondary border border-solid border-chatbox-border-secondary rounded-sm px-1 py-0.5 mx-1">dZ3</code>。<br/>
<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mfrac><mrow><mi mathvariant="normal">∂</mi><mi>L</mi></mrow><mrow><mi mathvariant="normal">∂</mi><msub><mi>z</mi><mi>i</mi></msub></mrow></mfrac></mrow><annotation encoding="application/x-tex">\frac{\partial L}{\partial z_i}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.3252em;vertical-align:-0.4451em"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8801em"><span style="top:-2.655em"><span class="pstrut" style="height:3em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight" style="margin-right:0.05556em">∂</span><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.04398em">z</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3281em"><span style="top:-2.357em;margin-left:-0.044em;margin-right:0.0714em"><span class="pstrut" style="height:2.5em"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em"><span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em"><span class="pstrut" style="height:3em"></span><span class="frac-line" style="border-bottom-width:0.04em"></span></span><span style="top:-3.394em"><span class="pstrut" style="height:3em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight" style="margin-right:0.05556em">∂</span><span class="mord mathnormal mtight">L</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.4451em"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></p>
</li>
<li>
<p><strong>链式法则</strong>：<br/>
<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mfrac><mrow><mi mathvariant="normal">∂</mi><mi>L</mi></mrow><mrow><mi mathvariant="normal">∂</mi><msub><mi>z</mi><mi>i</mi></msub></mrow></mfrac><mo>=</mo><mfrac><mrow><mi mathvariant="normal">∂</mi><mi>L</mi></mrow><mrow><mi mathvariant="normal">∂</mi><msub><mi>a</mi><mi>i</mi></msub></mrow></mfrac><mo>⋅</mo><mfrac><mrow><mi mathvariant="normal">∂</mi><msub><mi>a</mi><mi>i</mi></msub></mrow><mrow><mi mathvariant="normal">∂</mi><msub><mi>z</mi><mi>i</mi></msub></mrow></mfrac><mo>+</mo><msub><mo>∑</mo><mrow><mi>k</mi><mo mathvariant="normal">≠</mo><mi>i</mi></mrow></msub><mfrac><mrow><mi mathvariant="normal">∂</mi><mi>L</mi></mrow><mrow><mi mathvariant="normal">∂</mi><msub><mi>a</mi><mi>k</mi></msub></mrow></mfrac><mo>⋅</mo><mfrac><mrow><mi mathvariant="normal">∂</mi><msub><mi>a</mi><mi>k</mi></msub></mrow><mrow><mi mathvariant="normal">∂</mi><msub><mi>z</mi><mi>i</mi></msub></mrow></mfrac></mrow><annotation encoding="application/x-tex">\frac{\partial L}{\partial z_i} = \frac{\partial L}{\partial a_i} \cdot \frac{\partial a_i}{\partial z_i} + \sum_{k \neq i} \frac{\partial L}{\partial a_k} \cdot \frac{\partial a_k}{\partial z_i}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.3252em;vertical-align:-0.4451em"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8801em"><span style="top:-2.655em"><span class="pstrut" style="height:3em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight" style="margin-right:0.05556em">∂</span><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.04398em">z</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3281em"><span style="top:-2.357em;margin-left:-0.044em;margin-right:0.0714em"><span class="pstrut" style="height:2.5em"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em"><span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em"><span class="pstrut" style="height:3em"></span><span class="frac-line" style="border-bottom-width:0.04em"></span></span><span style="top:-3.394em"><span class="pstrut" style="height:3em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight" style="margin-right:0.05556em">∂</span><span class="mord mathnormal mtight">L</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.4451em"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:1.3252em;vertical-align:-0.4451em"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8801em"><span style="top:-2.655em"><span class="pstrut" style="height:3em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight" style="margin-right:0.05556em">∂</span><span class="mord mtight"><span class="mord mathnormal mtight">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3281em"><span style="top:-2.357em;margin-left:0em;margin-right:0.0714em"><span class="pstrut" style="height:2.5em"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em"><span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em"><span class="pstrut" style="height:3em"></span><span class="frac-line" style="border-bottom-width:0.04em"></span></span><span style="top:-3.394em"><span class="pstrut" style="height:3em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight" style="margin-right:0.05556em">∂</span><span class="mord mathnormal mtight">L</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.4451em"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:1.3413em;vertical-align:-0.4451em"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8962em"><span style="top:-2.655em"><span class="pstrut" style="height:3em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight" style="margin-right:0.05556em">∂</span><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.04398em">z</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3281em"><span style="top:-2.357em;margin-left:-0.044em;margin-right:0.0714em"><span class="pstrut" style="height:2.5em"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em"><span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em"><span class="pstrut" style="height:3em"></span><span class="frac-line" style="border-bottom-width:0.04em"></span></span><span style="top:-3.4101em"><span class="pstrut" style="height:3em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight" style="margin-right:0.05556em">∂</span><span class="mord mtight"><span class="mord mathnormal mtight">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3281em"><span style="top:-2.357em;margin-left:0em;margin-right:0.0714em"><span class="pstrut" style="height:2.5em"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em"><span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.4451em"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:1.331em;vertical-align:-0.4509em"></span><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1864em"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em">k</span><span class="mrel mtight"><span class="mrel mtight"><span class="mord vbox mtight"><span class="thinbox mtight"><span class="rlap mtight"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em"></span><span class="inner"><span class="mord mtight"><span class="mrel mtight"></span></span></span><span class="fix"></span></span></span></span></span><span class="mrel mtight">=</span></span><span class="mord mathnormal mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.4358em"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8801em"><span style="top:-2.655em"><span class="pstrut" style="height:3em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight" style="margin-right:0.05556em">∂</span><span class="mord mtight"><span class="mord mathnormal mtight">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em"><span style="top:-2.3488em;margin-left:0em;margin-right:0.0714em"><span class="pstrut" style="height:2.5em"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1512em"><span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em"><span class="pstrut" style="height:3em"></span><span class="frac-line" style="border-bottom-width:0.04em"></span></span><span style="top:-3.394em"><span class="pstrut" style="height:3em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight" style="margin-right:0.05556em">∂</span><span class="mord mathnormal mtight">L</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.4509em"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:1.3471em;vertical-align:-0.4451em"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.902em"><span style="top:-2.655em"><span class="pstrut" style="height:3em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight" style="margin-right:0.05556em">∂</span><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.04398em">z</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3281em"><span style="top:-2.357em;margin-left:-0.044em;margin-right:0.0714em"><span class="pstrut" style="height:2.5em"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em"><span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em"><span class="pstrut" style="height:3em"></span><span class="frac-line" style="border-bottom-width:0.04em"></span></span><span style="top:-3.4159em"><span class="pstrut" style="height:3em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight" style="margin-right:0.05556em">∂</span><span class="mord mtight"><span class="mord mathnormal mtight">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em"><span style="top:-2.3488em;margin-left:0em;margin-right:0.0714em"><span class="pstrut" style="height:2.5em"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1512em"><span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.4451em"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span><br/>
<em>(注：因为Softmax的分母包含所有z，所以改变一个 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>z</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">z_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.04398em">z</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em"><span style="top:-2.55em;margin-left:-0.044em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span></span></span></span> 会影响所有的 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>a</mi></mrow><annotation encoding="application/x-tex">a</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em"></span><span class="mord mathnormal">a</span></span></span></span>)</em></p>
<p><strong>省略中间繁琐的微积分计算过程（涉及Softmax的求导），直接给结论：</strong></p>
<ul>
<li>当 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6595em"></span><span class="mord mathnormal">i</span></span></span></span> 是正确类别时（即 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>y</mi><mi>i</mi></msub><mo>=</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">y_i=1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:0.6444em"></span><span class="mord">1</span></span></span></span>），导数化简为 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>a</mi><mi>i</mi></msub><mo>−</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">a_i - 1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7333em;vertical-align:-0.15em"></span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:0.6444em"></span><span class="mord">1</span></span></span></span>。</li>
<li>当 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6595em"></span><span class="mord mathnormal">i</span></span></span></span> 不是正确类别时（即 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>y</mi><mi>i</mi></msub><mo>=</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">y_i=0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:0.6444em"></span><span class="mord">0</span></span></span></span>），导数化简为 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>a</mi><mi>i</mi></msub><mo>−</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">a_i - 0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7333em;vertical-align:-0.15em"></span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:0.6444em"></span><span class="mord">0</span></span></span></span>。</li>
</ul>
<p>综合起来，导数就是：<br/>
<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mfrac><mrow><mi mathvariant="normal">∂</mi><mi>L</mi></mrow><mrow><mi mathvariant="normal">∂</mi><mi>z</mi></mrow></mfrac><mo>=</mo><mi>a</mi><mo>−</mo><mi>y</mi></mrow><annotation encoding="application/x-tex">\frac{\partial L}{\partial z} = a - y</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.2251em;vertical-align:-0.345em"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8801em"><span style="top:-2.655em"><span class="pstrut" style="height:3em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight" style="margin-right:0.05556em">∂</span><span class="mord mathnormal mtight" style="margin-right:0.04398em">z</span></span></span></span><span style="top:-3.23em"><span class="pstrut" style="height:3em"></span><span class="frac-line" style="border-bottom-width:0.04em"></span></span><span style="top:-3.394em"><span class="pstrut" style="height:3em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight" style="margin-right:0.05556em">∂</span><span class="mord mathnormal mtight">L</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:0.6667em;vertical-align:-0.0833em"></span><span class="mord mathnormal">a</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em"></span><span class="mord mathnormal" style="margin-right:0.03588em">y</span></span></span></span></p>
<p><strong>对应代码：</strong></p>
<pre><div style="--stack-gap:0rem;--stack-align:stretch;--stack-justify:flex-start" class="m_6d731127 mantine-Stack-root"><div style="justify-content:space-between" class="p-xs bg-chatbox-background-secondary rounded-t-md border border-solid border-[var(--chatbox-border-primary)] sticky top-0 z-10 m_8bffd616 mantine-Flex-root __m__-R3bi27"><div style="gap:var(--mantine-spacing-xs);align-items:center" class="m_8bffd616 mantine-Flex-root __m__-Rrbbi27"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--chatbox-tint-tertiary)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="tabler-icon tabler-icon-brand-python "><path d="M12 9h-7a2 2 0 0 0 -2 2v4a2 2 0 0 0 2 2h3"></path><path d="M12 15h7a2 2 0 0 0 2 -2v-4a2 2 0 0 0 -2 -2h-3"></path><path d="M8 9v-4a2 2 0 0 1 2 -2h4a2 2 0 0 1 2 2v5a2 2 0 0 1 -2 2h-4a2 2 0 0 0 -2 2v5a2 2 0 0 0 2 2h4a2 2 0 0 0 2 -2v-4"></path><path d="M11 6l0 .01"></path><path d="M13 18l0 .01"></path></svg><span style="color:chatbox-tertiary;font-weight:600" class="mantine-focus-auto font-mono m_b6d8b162 mantine-Text-root">PYTHON</span></div><div style="gap:var(--mantine-spacing-xs);align-items:center" class="m_8bffd616 mantine-Flex-root __m__-R1bbbi27"></div></div><div style="--stack-gap:var(--mantine-spacing-md);--stack-align:stretch;--stack-justify:flex-start" class="border border-t-0 border-solid border-[var(--chatbox-border-primary)] rounded-b-md m_6d731127 mantine-Stack-root"><div style="background:transparent !important;color:hsl(220, 14%, 71%);text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:&quot;Fira Code&quot;, &quot;Fira Mono&quot;, Menlo, Consolas, &quot;DejaVu Sans Mono&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:0;overflow:auto;border-radius:0.3em;margin-top:0;border-top-left-radius:0;border-top-right-radius:0;border-bottom-left-radius:var(--chatbox-radius-md);border-bottom-right-radius:var(--chatbox-radius-md);border:none"><code class="!bg-transparent" style="white-space:pre"><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">1</span><span>dZ3 </span><span class="token" style="color:hsl(207, 82%, 66%)">=</span><span> self</span><span class="token" style="color:hsl(220, 14%, 71%)">.</span><span>A3 </span><span class="token" style="color:hsl(207, 82%, 66%)">-</span><span> y  </span><span class="token" style="color:hsl(220, 10%, 40%);font-style:italic"># 预测概率 - 真实标签</span><span>
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">2</span></code></div></div></div></pre>
<p>这就是为什么这里只是简单的减法。这是Softmax+CrossEntropy组合特有的“魔法”。</p>
</li>
</ol>
<hr/>
<h3>3. 为什么 <code class="bg-chatbox-background-secondary border border-solid border-chatbox-border-secondary rounded-sm px-1 py-0.5 mx-1">dW3 = np.dot(self.A2.T, dZ3) / m</code>？</h3>
<p>这里包含三个问题：链式法则、矩阵形状匹配（转置）、以及为什么要除以 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>m</mi></mrow><annotation encoding="application/x-tex">m</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em"></span><span class="mord mathnormal">m</span></span></span></span>。</p>
<h4>A. 链式法则求 dW</h4>
<p>我们要更新权重 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>W</mi><mn>3</mn></mrow><annotation encoding="application/x-tex">W3</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em"></span><span class="mord mathnormal" style="margin-right:0.13889em">W</span><span class="mord">3</span></span></span></span>，就需要求损失对 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>W</mi><mn>3</mn></mrow><annotation encoding="application/x-tex">W3</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em"></span><span class="mord mathnormal" style="margin-right:0.13889em">W</span><span class="mord">3</span></span></span></span> 的导数。<br/>
根据前向传播公式：<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Z</mi><mn>3</mn><mo>=</mo><mi>A</mi><mn>2</mn><mo>⋅</mo><mi>W</mi><mn>3</mn><mo>+</mo><mi>b</mi><mn>3</mn></mrow><annotation encoding="application/x-tex">Z3 = A2 \cdot W3 + b3</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em"></span><span class="mord mathnormal" style="margin-right:0.07153em">Z</span><span class="mord">3</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:0.6833em"></span><span class="mord mathnormal">A</span><span class="mord">2</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:0.7667em;vertical-align:-0.0833em"></span><span class="mord mathnormal" style="margin-right:0.13889em">W</span><span class="mord">3</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:0.6944em"></span><span class="mord mathnormal">b</span><span class="mord">3</span></span></span></span></p>
<p>链式法则告诉我们：<br/>
<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mfrac><mrow><mi mathvariant="normal">∂</mi><mi>L</mi></mrow><mrow><mi mathvariant="normal">∂</mi><mi>W</mi><mn>3</mn></mrow></mfrac><mo>=</mo><mfrac><mrow><mi mathvariant="normal">∂</mi><mi>L</mi></mrow><mrow><mi mathvariant="normal">∂</mi><mi>Z</mi><mn>3</mn></mrow></mfrac><mo>⋅</mo><mfrac><mrow><mi mathvariant="normal">∂</mi><mi>Z</mi><mn>3</mn></mrow><mrow><mi mathvariant="normal">∂</mi><mi>W</mi><mn>3</mn></mrow></mfrac></mrow><annotation encoding="application/x-tex">\frac{\partial L}{\partial W3} = \frac{\partial L}{\partial Z3} \cdot \frac{\partial Z3}{\partial W3}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.2251em;vertical-align:-0.345em"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8801em"><span style="top:-2.655em"><span class="pstrut" style="height:3em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight" style="margin-right:0.05556em">∂</span><span class="mord mathnormal mtight" style="margin-right:0.13889em">W</span><span class="mord mtight">3</span></span></span></span><span style="top:-3.23em"><span class="pstrut" style="height:3em"></span><span class="frac-line" style="border-bottom-width:0.04em"></span></span><span style="top:-3.394em"><span class="pstrut" style="height:3em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight" style="margin-right:0.05556em">∂</span><span class="mord mathnormal mtight">L</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:1.2251em;vertical-align:-0.345em"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8801em"><span style="top:-2.655em"><span class="pstrut" style="height:3em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight" style="margin-right:0.05556em">∂</span><span class="mord mathnormal mtight" style="margin-right:0.07153em">Z</span><span class="mord mtight">3</span></span></span></span><span style="top:-3.23em"><span class="pstrut" style="height:3em"></span><span class="frac-line" style="border-bottom-width:0.04em"></span></span><span style="top:-3.394em"><span class="pstrut" style="height:3em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight" style="margin-right:0.05556em">∂</span><span class="mord mathnormal mtight">L</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:1.2251em;vertical-align:-0.345em"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8801em"><span style="top:-2.655em"><span class="pstrut" style="height:3em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight" style="margin-right:0.05556em">∂</span><span class="mord mathnormal mtight" style="margin-right:0.13889em">W</span><span class="mord mtight">3</span></span></span></span><span style="top:-3.23em"><span class="pstrut" style="height:3em"></span><span class="frac-line" style="border-bottom-width:0.04em"></span></span><span style="top:-3.394em"><span class="pstrut" style="height:3em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight" style="margin-right:0.05556em">∂</span><span class="mord mathnormal mtight" style="margin-right:0.07153em">Z</span><span class="mord mtight">3</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></p>
<ul>
<li>我们已经算出了 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mfrac><mrow><mi mathvariant="normal">∂</mi><mi>L</mi></mrow><mrow><mi mathvariant="normal">∂</mi><mi>Z</mi><mn>3</mn></mrow></mfrac></mrow><annotation encoding="application/x-tex">\frac{\partial L}{\partial Z3}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.2251em;vertical-align:-0.345em"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8801em"><span style="top:-2.655em"><span class="pstrut" style="height:3em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight" style="margin-right:0.05556em">∂</span><span class="mord mathnormal mtight" style="margin-right:0.07153em">Z</span><span class="mord mtight">3</span></span></span></span><span style="top:-3.23em"><span class="pstrut" style="height:3em"></span><span class="frac-line" style="border-bottom-width:0.04em"></span></span><span style="top:-3.394em"><span class="pstrut" style="height:3em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight" style="margin-right:0.05556em">∂</span><span class="mord mathnormal mtight">L</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span>，就是上面的 <code class="bg-chatbox-background-secondary border border-solid border-chatbox-border-secondary rounded-sm px-1 py-0.5 mx-1">dZ3</code>。</li>
<li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mfrac><mrow><mi mathvariant="normal">∂</mi><mi>Z</mi><mn>3</mn></mrow><mrow><mi mathvariant="normal">∂</mi><mi>W</mi><mn>3</mn></mrow></mfrac></mrow><annotation encoding="application/x-tex">\frac{\partial Z3}{\partial W3}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.2251em;vertical-align:-0.345em"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8801em"><span style="top:-2.655em"><span class="pstrut" style="height:3em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight" style="margin-right:0.05556em">∂</span><span class="mord mathnormal mtight" style="margin-right:0.13889em">W</span><span class="mord mtight">3</span></span></span></span><span style="top:-3.23em"><span class="pstrut" style="height:3em"></span><span class="frac-line" style="border-bottom-width:0.04em"></span></span><span style="top:-3.394em"><span class="pstrut" style="height:3em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight" style="margin-right:0.05556em">∂</span><span class="mord mathnormal mtight" style="margin-right:0.07153em">Z</span><span class="mord mtight">3</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span> 其实就是输入给这一层的激活值 <code class="bg-chatbox-background-secondary border border-solid border-chatbox-border-secondary rounded-sm px-1 py-0.5 mx-1">A2</code>。</li>
</ul>
<p>所以，从标量（单个数值）的角度看：梯度 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>≈</mo><mi>A</mi><mn>2</mn><mo>×</mo><mi>d</mi><mi>Z</mi><mn>3</mn></mrow><annotation encoding="application/x-tex">\approx A2 \times dZ3</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4831em"></span><span class="mrel">≈</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:0.7667em;vertical-align:-0.0833em"></span><span class="mord mathnormal">A</span><span class="mord">2</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:0.6944em"></span><span class="mord mathnormal">d</span><span class="mord mathnormal" style="margin-right:0.07153em">Z</span><span class="mord">3</span></span></span></span>。</p>
<h4>B. 矩阵形状与转置 (A2.T)</h4>
<p>在代码中，我们处理的是<strong>批量数据（Batch）</strong>，所以全是矩阵操作。让我们看维度（Shape）：</p>
<ul>
<li><strong><code class="bg-chatbox-background-secondary border border-solid border-chatbox-border-secondary rounded-sm px-1 py-0.5 mx-1">dZ3</code> 的形状</strong>: <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mi>m</mi><mo separator="true">,</mo><mn>10</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(m, 10)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mopen">(</span><span class="mord mathnormal">m</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord">10</span><span class="mclose">)</span></span></span></span>。
<ul>
<li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>m</mi></mrow><annotation encoding="application/x-tex">m</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em"></span><span class="mord mathnormal">m</span></span></span></span> 是样本数（比如64），10是输出分类数。</li>
</ul>
</li>
<li><strong><code class="bg-chatbox-background-secondary border border-solid border-chatbox-border-secondary rounded-sm px-1 py-0.5 mx-1">A2</code> 的形状</strong>: <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mi>m</mi><mo separator="true">,</mo><mn>16</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(m, 16)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mopen">(</span><span class="mord mathnormal">m</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord">16</span><span class="mclose">)</span></span></span></span>。
<ul>
<li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>m</mi></mrow><annotation encoding="application/x-tex">m</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em"></span><span class="mord mathnormal">m</span></span></span></span> 是样本数，16是隐藏层神经元数。</li>
</ul>
</li>
<li><strong><code class="bg-chatbox-background-secondary border border-solid border-chatbox-border-secondary rounded-sm px-1 py-0.5 mx-1">W3</code> 的形状</strong>: <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mn>16</mn><mo separator="true">,</mo><mn>10</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(16, 10)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mopen">(</span><span class="mord">16</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord">10</span><span class="mclose">)</span></span></span></span>。
<ul>
<li>我们要计算的梯度 <code class="bg-chatbox-background-secondary border border-solid border-chatbox-border-secondary rounded-sm px-1 py-0.5 mx-1">dW3</code> 形状必须和 <code class="bg-chatbox-background-secondary border border-solid border-chatbox-border-secondary rounded-sm px-1 py-0.5 mx-1">W3</code> 一样，也是 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mn>16</mn><mo separator="true">,</mo><mn>10</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(16, 10)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mopen">(</span><span class="mord">16</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord">10</span><span class="mclose">)</span></span></span></span>。</li>
</ul>
</li>
</ul>
<p>现在我们要把 <code class="bg-chatbox-background-secondary border border-solid border-chatbox-border-secondary rounded-sm px-1 py-0.5 mx-1">A2</code> <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mi>m</mi><mo separator="true">,</mo><mn>16</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(m, 16)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mopen">(</span><span class="mord mathnormal">m</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord">16</span><span class="mclose">)</span></span></span></span> 和 <code class="bg-chatbox-background-secondary border border-solid border-chatbox-border-secondary rounded-sm px-1 py-0.5 mx-1">dZ3</code> <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mi>m</mi><mo separator="true">,</mo><mn>10</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(m, 10)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mopen">(</span><span class="mord mathnormal">m</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord">10</span><span class="mclose">)</span></span></span></span> 相乘，得到 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mn>16</mn><mo separator="true">,</mo><mn>10</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(16, 10)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mopen">(</span><span class="mord">16</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord">10</span><span class="mclose">)</span></span></span></span>。<br/>
直接乘肯定不行（<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mi>m</mi><mo separator="true">,</mo><mn>16</mn><mo stretchy="false">)</mo><mo>×</mo><mo stretchy="false">(</mo><mi>m</mi><mo separator="true">,</mo><mn>10</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(m,16) \times (m,10)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mopen">(</span><span class="mord mathnormal">m</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord">16</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mopen">(</span><span class="mord mathnormal">m</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord">10</span><span class="mclose">)</span></span></span></span> 无法运算）。</p>
<p>唯一的办法是<strong>把 <code class="bg-chatbox-background-secondary border border-solid border-chatbox-border-secondary rounded-sm px-1 py-0.5 mx-1">A2</code> 转置</strong>：</p>
<ul>
<li><code class="bg-chatbox-background-secondary border border-solid border-chatbox-border-secondary rounded-sm px-1 py-0.5 mx-1">A2.T</code> 的形状变成 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mn>16</mn><mo separator="true">,</mo><mi>m</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(16, m)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mopen">(</span><span class="mord">16</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord mathnormal">m</span><span class="mclose">)</span></span></span></span>。</li>
<li>矩阵乘法：<code class="bg-chatbox-background-secondary border border-solid border-chatbox-border-secondary rounded-sm px-1 py-0.5 mx-1">np.dot(A2.T, dZ3)</code></li>
<li>维度运算：<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mn>16</mn><mo separator="true">,</mo><mi>m</mi><mo stretchy="false">)</mo><mo>×</mo><mo stretchy="false">(</mo><mi>m</mi><mo separator="true">,</mo><mn>10</mn><mo stretchy="false">)</mo><mo>=</mo><mo stretchy="false">(</mo><mn>16</mn><mo separator="true">,</mo><mn>10</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(16, m) \times (m, 10) = (16, 10)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mopen">(</span><span class="mord">16</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord mathnormal">m</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mopen">(</span><span class="mord mathnormal">m</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord">10</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mopen">(</span><span class="mord">16</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord">10</span><span class="mclose">)</span></span></span></span>。</li>
</ul>
<p><strong>这就得到了形状正确的梯度矩阵！这就是 <code class="bg-chatbox-background-secondary border border-solid border-chatbox-border-secondary rounded-sm px-1 py-0.5 mx-1">A2.T</code> 存在的意义。</strong></p>
<h4>C. 为什么要除以 m？</h4>
<pre><div style="--stack-gap:0rem;--stack-align:stretch;--stack-justify:flex-start" class="m_6d731127 mantine-Stack-root"><div style="justify-content:space-between" class="p-xs bg-chatbox-background-secondary rounded-t-md border border-solid border-[var(--chatbox-border-primary)] sticky top-0 z-10 m_8bffd616 mantine-Flex-root __m__-Rdef"><div style="gap:var(--mantine-spacing-xs);align-items:center" class="m_8bffd616 mantine-Flex-root __m__-R3ddef"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--chatbox-tint-tertiary)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="tabler-icon tabler-icon-brand-python "><path d="M12 9h-7a2 2 0 0 0 -2 2v4a2 2 0 0 0 2 2h3"></path><path d="M12 15h7a2 2 0 0 0 2 -2v-4a2 2 0 0 0 -2 -2h-3"></path><path d="M8 9v-4a2 2 0 0 1 2 -2h4a2 2 0 0 1 2 2v5a2 2 0 0 1 -2 2h-4a2 2 0 0 0 -2 2v5a2 2 0 0 0 2 2h4a2 2 0 0 0 2 -2v-4"></path><path d="M11 6l0 .01"></path><path d="M13 18l0 .01"></path></svg><span style="color:chatbox-tertiary;font-weight:600" class="mantine-focus-auto font-mono m_b6d8b162 mantine-Text-root">PYTHON</span></div><div style="gap:var(--mantine-spacing-xs);align-items:center" class="m_8bffd616 mantine-Flex-root __m__-R5ddef"></div></div><div style="--stack-gap:var(--mantine-spacing-md);--stack-align:stretch;--stack-justify:flex-start" class="border border-t-0 border-solid border-[var(--chatbox-border-primary)] rounded-b-md m_6d731127 mantine-Stack-root"><div style="background:transparent !important;color:hsl(220, 14%, 71%);text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:&quot;Fira Code&quot;, &quot;Fira Mono&quot;, Menlo, Consolas, &quot;DejaVu Sans Mono&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:0;overflow:auto;border-radius:0.3em;margin-top:0;border-top-left-radius:0;border-top-right-radius:0;border-bottom-left-radius:var(--chatbox-radius-md);border-bottom-right-radius:var(--chatbox-radius-md);border:none"><code class="!bg-transparent" style="white-space:pre"><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">1</span><span>dW3 </span><span class="token" style="color:hsl(207, 82%, 66%)">=</span><span> </span><span class="token" style="color:hsl(220, 14%, 71%)">.</span><span class="token" style="color:hsl(220, 14%, 71%)">.</span><span class="token" style="color:hsl(220, 14%, 71%)">.</span><span> </span><span class="token" style="color:hsl(207, 82%, 66%)">/</span><span> m
</span><span class="linenumber react-syntax-highlighter-line-number" style="display:inline-block;min-width:2.25em;padding-right:1em;text-align:right;user-select:none;color:hsl(220, 10%, 40%);font-style:italic">2</span></code></div></div></div></pre>
<ul>
<li><strong><code class="bg-chatbox-background-secondary border border-solid border-chatbox-border-secondary rounded-sm px-1 py-0.5 mx-1">np.dot</code> 的累加效应</strong>：当你做矩阵乘法 <code class="bg-chatbox-background-secondary border border-solid border-chatbox-border-secondary rounded-sm px-1 py-0.5 mx-1">np.dot(A2.T, dZ3)</code> 时，本质上你是把这 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>m</mi></mrow><annotation encoding="application/x-tex">m</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em"></span><span class="mord mathnormal">m</span></span></span></span> 个样本（比如64个图片）计算出来的梯度<strong>全部加在一起</strong>了。</li>
<li><strong>总误差 vs 平均误差</strong>：
<ul>
<li>如果只求和不平均，那么你的 Batch Size（<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>m</mi></mrow><annotation encoding="application/x-tex">m</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em"></span><span class="mord mathnormal">m</span></span></span></span>）越大，计算出来的梯度数值就越大。</li>
<li>这意味着如果你把 Batch Size 从 64 改成 128，你的梯度会翻倍，你的学习率（Learning Rate）就得减半才能保持稳定。这很麻烦。</li>
</ul>
</li>
<li><strong>解决方案</strong>：为了让梯度的规模不依赖于 Batch Size 的大小，我们计算<strong>平均梯度</strong>。
<ul>
<li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>m</mi></mrow><annotation encoding="application/x-tex">m</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em"></span><span class="mord mathnormal">m</span></span></span></span> 就是样本数量。</li>
<li>除以 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>m</mi></mrow><annotation encoding="application/x-tex">m</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em"></span><span class="mord mathnormal">m</span></span></span></span>，就是计算这批样本的<strong>平均</strong>梯度方向。</li>
</ul>
</li>
</ul>
<h3>总结</h3>
<ol>
<li><strong><code class="bg-chatbox-background-secondary border border-solid border-chatbox-border-secondary rounded-sm px-1 py-0.5 mx-1">dZ3 = A3 - y</code></strong>：这是数学上的巧合，Softmax 配合交叉熵损失求导后，恰好等于“预测值减去真实值”。</li>
<li><strong><code class="bg-chatbox-background-secondary border border-solid border-chatbox-border-secondary rounded-sm px-1 py-0.5 mx-1">A2.T</code></strong>：是为了在矩阵乘法中对齐维度，利用前一层的激活值和当前的误差来计算权重的梯度。</li>
<li><strong><code class="bg-chatbox-background-secondary border border-solid border-chatbox-border-secondary rounded-sm px-1 py-0.5 mx-1">/ m</code></strong>：是为了计算平均梯度，防止因为 Batch Size 变化导致梯度数值剧烈波动。</li>
</ol></div></div>
<hr />
</div>

        <hr />
        <a href="https://chatboxai.app" style="display: flex; align-items: center;" class="text-sky-500" target="_blank">
            <img src='https://chatboxai.app/icon.png' class="w-12 pr-2">
            <b style='font-size:30px'>Chatbox AI</b>
        </a>
        <p><a a href="https://chatboxai.app" target="_blank">https://chatboxai.app</a></p>
    </div>
</body>
</html>
